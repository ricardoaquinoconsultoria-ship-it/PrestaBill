<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Presta Bill - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<script src="https://www.paypal.com/sdk/js?client-id=AXf2lr335i2eqVAM2TU36CzKEMQDost41DOaPqCx_T7PfUqY0OKnZamVmH6jfguv0Q0i7ree0dc82wwE&vault=true&intent=subscription"></script>


<style>
/* =============================================== */
/* ESTILOS GENERALES Y LAYOUT */
/* =============================================== */
*, *::before, *::after {
  box-sizing: border-box; 
}

body { 
  margin:0; 
  font-family: 'Roboto', sans-serif; 
  background:#f9f9f9; 
  color: #333;
}

header { 
  background:#1c5d99; 
  color:white; 
  padding:15px; 
  font-size:24px; 
  font-weight: 700;
  display:flex; 
  align-items:center; 
  z-index:1000; 
  position:fixed; 
  top:0; 
  width:100%; 
  left: 0;
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#menu-toggle { 
  cursor:pointer; 
  margin-right:15px; 
  font-size:28px; 
  transition: opacity 0.2s;
}
#menu-toggle:hover { opacity: 0.8; }

aside {
  width:260px;
  background:#2c3e50; 
  color:white;
  padding:10px 0; 
  position:fixed;
  top:0; 
  left:-260px; 
  height:100vh; 
  transition: left 0.3s ease;
  z-index:1001; 
  box-sizing: border-box;
  overflow-y: auto; 
  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
}
aside.open { left:0; }

.nav-btn { 
  width:calc(100% - 20px); 
  background:transparent; 
  padding:12px 15px; 
  border:none; 
  color:white; 
  margin:5px 10px; 
  cursor:pointer; 
  text-align:left; 
  border-radius:6px; 
  font-size:16px; 
  transition: background 0.3s;
  font-weight: 400;
}
.nav-btn:hover { 
  background:#34495e; 
} 

.btn-suscripcion {
    width:calc(100% - 20px); 
    background-color: #2ecc71; 
    color: white;
    padding: 12px 15px;
    border: none;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
    margin: 5px 10px 10px 10px; 
    text-align: center;
    font-weight: bold;
    transition: background 0.3s;
}
.btn-suscripcion:hover {
    background-color: #27ae60;
}

main {
  padding: 90px 20px 20px 20px; 
  margin-left: 0; 
  transition: margin-left 0.3s ease;
  width: auto; 
}

.card { 
  background:white; 
  padding:20px; 
  border-radius:10px; 
  margin-bottom:20px; 
  min-height: 100px;
  border: 1px solid #e0e0e0; 
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); 
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
}
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}


.dashboard-cards-container {
    display:flex; 
    gap:20px; 
    flex-wrap:wrap; 
    margin-bottom:20px;
}
.dashboard-cards-container .card {
    flex: 1 1 200px;
    margin-bottom: 0; 
}

#clients-list, #loans-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
  gap: 20px; 
}

.form-input {
  width: 100%; 
  padding: 12px; 
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 16px;
  transition: border-color 0.3s, box-shadow 0.3s;
}
.form-input:focus {
    border-color: #1c5d99;
    outline: none;
    box-shadow: 0 0 5px rgba(28, 93, 153, 0.4);
}

.action-btn {
  background:#1c5d99; 
  color:white; 
  padding:12px; 
  border:none; 
  border-radius:6px; 
  cursor:pointer;
  width: 100%; 
  font-size: 16px;
  font-weight: bold;
  transition: background 0.3s, transform 0.1s;
}
.action-btn:hover { 
    background:#174a7a; 
}
.action-btn:active {
    transform: scale(0.98);
}

.table-responsive-container {
    overflow-x: auto; 
    width: 100%;
}

table {
    width: 100%;
    border-collapse: collapse;
    min-width: 700px; 
}

table td, table th {
    padding: 12px 10px; 
    border: none; 
    text-align: left;
    vertical-align: middle; 
}

table th {
    background: #e6e6e6; 
    font-weight: 700;
    color: #333;
}

.neutral-row-even {
    background: #fff !important; 
}
.neutral-row-odd {
    background: #f0f4f7 !important; 
}

table tr:not(.neutral-header) {
    cursor: pointer;
}
table tr:not(.neutral-header):hover {
    background: #e9eff5 !important;
}


.client-loan-cell {
    max-width: 250px; 
    white-space: normal; 
    word-break: break-word; 
    overflow-wrap: break-word; 
    vertical-align: middle; 
}

.neutral-header {
    background: #1c5d99 !important; 
    color: white !important; 
    font-weight: bold;
}

.mora-alert-text {
    font-weight: bold;
    color: #e74c3c; 
}

.card-no-border-left {
    border-left: 1px solid #e0e0e0 !important; 
}

#mora-loans-detail-container {
    border: 1px solid #e0e0e0;
    background: white;
    padding: 15px;
    border-radius: 10px;
    margin-top: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* === MODALES === */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(5px); 
}
.modal-content {
    background: white;
    padding: 20px; 
    border-radius: 8px;
    max-width: 800px; 
    width: 90%;
    max-height: 90%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    border-bottom: 1px solid #ccc;
    margin-bottom: 10px;
}
.modal-header h3 {
    margin: 0;
    color: #1c5d99;
}
.modal-close-btn {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 15px; 
    cursor: pointer;
    font-weight: bold;
    transition: background 0.2s;
}
.modal-close-btn:hover {
    background: #c0392b;
}
#invoice-iframe {
    width: 100%;
    flex-grow: 1;
    min-height: 500px; 
    border: 1px solid #ddd;
    border-radius: 4px;
}
.modal-download-btn {
    margin-top: 15px; 
    background: #2ecc71;
}

/* === SNACKBAR / TOAST === */
#snackbar {
    visibility: hidden; 
    min-width: 250px;
    margin-left: -125px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 16px;
    position: fixed;
    z-index: 3000; 
    left: 50%;
    bottom: 30px; 
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    font-weight: bold;
}

#snackbar.show {
    visibility: visible;
    -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
    animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

#snackbar.success { background-color: #2ecc71; }
#snackbar.error { background-color: #e74c3c; }
#snackbar.warning { background-color: #f39c12; }
#snackbar.info { background-color: #1c5d99; }

@-webkit-keyframes fadein {
    from {bottom: 0; opacity: 0;} 
    to {bottom: 30px; opacity: 1;}
}

@keyframes fadein {
    from {bottom: 0; opacity: 0;}
    to {bottom: 30px; opacity: 1;}
}

@-webkit-keyframes fadeout {
    from {bottom: 30px; opacity: 1;} 
    to {bottom: 0; opacity: 0;}
}

@keyframes fadeout {
    from {bottom: 30px; opacity: 1;}
    to {bottom: 0; opacity: 0;}
}

@media (min-width: 768px) {
    main.shifted { 
        margin-left: 260px; 
    }
}

/* === ESTILOS DEL MODAL DE SUSCRIPCI√ìN === */
#modal-overlay {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.6);
    backdrop-filter: blur(3px);
    z-index: 999;
    justify-content: center;
    align-items: center;
}

#modal-box {
    background: white;
    width: 90%;
    max-width: 420px;
    padding: 25px;
    border-radius: 10px;
    text-align: center;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    animation: fadeIn 0.25s ease-in-out;
}

@keyframes fadeIn {
    from { opacity: 0; transform: scale(0.95); }
    to   { opacity: 1; transform: scale(1); }
}

#close-modal {
    border: none;
    background: red;
    color: white;
    padding: 8px 14px;
    border-radius: 5px;
    margin-top: 15px;
    cursor: pointer;
}

/* === NUEVOS ESTILOS PARA EL CARRUSEL DE PAGOS === */
.carousel-container {
    position: relative;
    overflow: hidden;
    background: #f0f7ff;
    padding: 15px;
    border-radius: 10px;
    border: 1px solid #d0e8ff;
}

.carousel-slides {
    display: flex;
    overflow-x: scroll; /* Permite deslizar horizontalmente */
    scroll-snap-type: x mandatory; /* Hace que se detenga en cada tarjeta */
    -webkit-overflow-scrolling: touch; /* Suaviza el scroll en iOS */
    gap: 15px;
    padding: 5px; /* Espacio interno para sombra */
}

.carousel-slides::-webkit-scrollbar {
    display: none; /* Ocultar la barra de scroll */
}

.carousel-item {
    flex: 0 0 90%; /* Ancho del 90% del contenedor en m√≥vil */
    scroll-snap-align: start;
    background: white;
    padding: 15px;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    border-left: 5px solid #1c5d99;
    min-width: 280px; /* Asegurar un m√≠nimo para desktop */
    transition: transform 0.2s;
    cursor: pointer;
}

.carousel-item:hover {
    transform: translateY(-2px);
}

.carousel-item h4 {
    margin: 0 0 5px 0;
    color: #1c5d99;
}

.carousel-item p {
    margin: 5px 0;
}

.carousel-item-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 10px;
    padding-top: 10px;
    border-top: 1px dashed #ddd;
}

.carousel-nav-btn {
    position: absolute;
    top: 50%;
    transform: translateY(-50%);
    background: rgba(28, 93, 153, 0.8);
    color: white;
    border: none;
    padding: 10px;
    cursor: pointer;
    z-index: 10;
    font-size: 18px;
    line-height: 1;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
    opacity: 0.8;
    transition: opacity 0.2s;
}

.carousel-nav-btn:hover {
    opacity: 1;
}

#prev-btn { left: 5px; }
#next-btn { right: 5px; }

/* Ajuste responsive para desktop */
@media (min-width: 768px) {
    .carousel-item {
        flex: 0 0 calc(33.33% - 10px); /* 3 elementos por fila */
    }
    .carousel-slides {
        overflow-x: hidden; /* Ocultar la barra de scroll en desktop */
    }
}
/* === FIN ESTILOS CARRUSEL === */

</style>
</head>
<body>

<header id="app-header">
  <span id="menu-toggle" 
        role="button" 
        aria-controls="sidebar" 
        aria-expanded="false" 
        tabindex="0">‚ò∞</span>
  Presta Bill
</header>

<aside id="sidebar">
    <h3 style="padding:15px; margin:0; text-align:center; color:#fff; border-bottom:1px solid #34495e;">Men√∫ Principal</h3>
  <button class="nav-btn" type="button" onclick="renderDashboard(); closeSidebar();">üè† Inicio</button>
  <button class="nav-btn" type="button" onclick="renderClients(); closeSidebar();">üë• Clientes</button>
  <button class="nav-btn" type="button" onclick="renderLoans(); closeSidebar();">üíµ Pr√©stamos</button>
  <button class="nav-btn" type="button" onclick="renderCobros(); closeSidebar();">üí∞ Cobros</button>
  <button class="nav-btn" type="button" onclick="renderReports(); closeSidebar();">üìä Reportes</button>
  <button class="nav-btn" type="button" onclick="renderCobrosHistory(); closeSidebar();">üìú Historial Transacciones</button>
  <button class="nav-btn" type="button" onclick="renderSettings(); closeSidebar();">‚öôÔ∏è Configuraciones</button>
  <button class="nav-btn" type="button" onclick="renderMaintenance(); closeSidebar();">üíæ Mantenimiento</button>
  
  <button class="btn-suscripcion" type="button" onclick="abrirModal()">‚≠ê Suscripci√≥n</button>
  </aside>

<main id="main"></main>

<div id="modal-overlay" class="modal-overlay">
  <div id="modal-box" class="modal-content" style="max-width: 420px; max-height: 400px; display: block;">
    <h3 style="margin-top:0; color:#1c5d99;">Actualiza a Premium</h3>
    <p>Tu acceso actual es limitado. Suscr√≠bete para acceder a todas las funciones sin restricciones.</p>
    <div id="paypal-button-container"></div>
    <button id="close-modal" onclick="cerrarModal()">Cerrar</button>
  </div>
</div>
<div id="invoice-modal" class="modal-overlay" onclick="if(event.target.id === 'invoice-modal') closeInvoiceModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-invoice-title">Factura de Cobro</h3>
            <button class="modal-close-btn" onclick="closeInvoiceModal()">X Cerrar</button>
        </div>
        <iframe id="invoice-iframe" title="Visualizaci√≥n de Factura PDF"></iframe>
        
        <button id="modal-download-btn" class="action-btn modal-download-btn" onclick="downloadInvoice()">‚¨áÔ∏è Descargar PDF</button>
    </div>
</div>

<div id="snackbar"></div>

<script>
// ===============================================
// L√ìGICA DE SUSCRIPCI√ìN (TU C√ìDIGO) - MEJORADO
// ===============================================
const TRIAL_DAYS = 3;

// Iniciar trial autom√°ticamente si no existe
if(!localStorage.getItem("trialStart")){
  localStorage.setItem("trialStart", new Date().getTime());
  localStorage.setItem("paypalSubscription","inactive");
}

// Funciones de control
function diasRestantesTrial() {
  const inicio = parseInt(localStorage.getItem("trialStart"));
  const ahora = new Date().getTime();
  const diasPasados = Math.floor((ahora - inicio)/(1000*60*60*24));
  return TRIAL_DAYS - diasPasados;
}
function trialActivo() { return diasRestantesTrial() > 0; }
function suscripcionActiva() { return localStorage.getItem("paypalSubscription") === "active"; }

// Mostrar modal autom√°ticamente si termin√≥ el trial
function verificarAcceso() {
  // Solo abrir el modal si el men√∫ no est√° ya abierto
  if(!trialActivo() && !suscripcionActiva() && !sidebar.classList.contains("open")){
    abrirModal();
  }
}

// Abrir/cerrar modal - A√ëADIDA LLAMADA A CARGAR BOT√ìN AQU√ç
function abrirModal(){ 
    document.getElementById("modal-overlay").style.display = "flex"; 
    if (!suscripcionActiva()) {
        cargarBotonPayPal();
    }
}
function cerrarModal(){ document.getElementById("modal-overlay").style.display = "none"; }

// Bot√≥n PayPal - CORREGIDO Y ROBUSTO CON CHEQUEO DEL SDK
function cargarBotonPayPal() {
  const container = document.getElementById('paypal-button-container');

  if (suscripcionActiva()) {
      container.innerHTML = 
        '<p style="color:#2ecc71; font-weight:bold;">¬°Ya tienes una Suscripci√≥n Premium activa!</p>';
      return; 
  } 
  
  // === MEJORA: Chequeo de Robustez del SDK de PayPal ===
  if (typeof window.paypal === 'undefined') {
      container.innerHTML = 
        '<p style="color:#e74c3c; font-weight:bold;">Error de Configuraci√≥n: El bot√≥n de PayPal no pudo cargarse. Revise la consola.</p>';
      showToast('Error de PayPal: El SDK no est√° disponible. Aseg√∫rese de que la etiqueta <script> en el HTML est√© correcta.', 'error');
      console.error("PayPal SDK no cargado. Verifique la etiqueta <script> de carga en el HTML.");
      return;
  }
  // =====================================================

  // LIMPIAR CONTENEDOR ANTES DE RENDERIZAR
  container.innerHTML = ''; 

  // Renderizar el bot√≥n
  paypal.Buttons({
    style: { shape:'rect', color:'gold', layout:'vertical', label:'subscribe' },
    createSubscription: function(data, actions){
      return actions.subscription.create({
        // Tu Plan ID de Suscripci√≥n (ya estaba correcto)
        plan_id: 'lYuXwwQW4lGA6LfZBic3BBpRhxCjZj4zv_2gRVR-' 
      });
    },
    onApprove: function(data){
      localStorage.setItem("paypalSubscription","active");
      cerrarModal();
      showToast('¬°Suscripci√≥n completada! Acceso Premium Activado.', 'success'); 
      renderDashboard(); 
    },
    onCancel: function (data) {
        showToast('Suscripci√≥n cancelada.', 'info');
    },
    onError: function (err) {
        showToast('Error en la suscripci√≥n: ' + err, 'error');
    }
  }).render(container); 

}
// ===============================================



// ===============================================
// L√ìGICA GENERAL Y DB
// ===============================================
const DEFAULT_SETTINGS = {
    baseInterestRate: 20, // % para 3 meses
    currencySymbol: 'RD$' 
};

// Activar jsPDF en el scope
const { jsPDF } = window.jspdf;

const DB = { 
  get: k => JSON.parse(localStorage.getItem(k)||"[]"), 
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
  
  getSettings: () => {
    let settings = localStorage.getItem("settings");
    if (!settings) {
        DB.set("settings", DEFAULT_SETTINGS);
        return DEFAULT_SETTINGS;
    }
    return {...DEFAULT_SETTINGS, ...JSON.parse(settings)};
  },
  
  getInitialCobros: () => {
      let cobros = localStorage.getItem("cobros");
      if (!cobros) {
          DB.set("cobros", []);
          return [];
      }
      return JSON.parse(cobros);
  }
};
const genId = () => "id"+Math.random().toString(36).substr(2,9);

const sidebar = document.getElementById("sidebar");
const main = document.getElementById("main");
const header = document.getElementById("app-header");
const menuToggle = document.getElementById("menu-toggle");
const snackbar = document.getElementById("snackbar"); 

function showToast(message, type = 'info') {
    snackbar.textContent = message;
    snackbar.className = "show " + type;
    setTimeout(function(){ 
        snackbar.className = snackbar.className.replace("show", ""); 
    }, 3000);
}

function formatCurrency(amount) {
    const settings = DB.getSettings();
    return `${settings.currencySymbol} ${Number(amount).toFixed(2)}`;
}


// ===============================================
// L√ìGICA DE INTERFAZ
// ===============================================
menuToggle.onclick = () => {
  const isOpening = !sidebar.classList.contains("open");
  
  sidebar.classList.toggle("open");
  
  menuToggle.setAttribute('aria-expanded', isOpening.toString());

  if (window.innerWidth >= 768) {
     main.classList.toggle("shifted");
  } else {
     main.classList.remove("shifted"); 
  }
  
  if (isOpening) {
      const firstNavBtn = sidebar.querySelector('.nav-btn');
      if (firstNavBtn) {
          firstNavBtn.focus();
      }
  }
};

function closeSidebar() {
  if (sidebar.classList.contains("open")) {
    sidebar.classList.remove("open");
    menuToggle.setAttribute('aria-expanded', 'false'); 
    
    if (window.innerWidth >= 768) {
        main.classList.remove("shifted"); 
    }
  }
}

// ===============================================
// FUNCI√ìN DE C√ÅLCULO DE RIESGO DE MORA
// ===============================================
function calculateLoanRisk(loan) {
    const today = new Date();
    const startDate = new Date(loan.startDate + 'T00:00:00'); 
    const cuotaMensual = Number(loan.monthlyPayment);
    const paymentsMade = Number(loan.paymentsMade);
    const termMonths = Number(loan.termMonths);

    if (loan.status === 'Pagado') {
        return { paymentsDue: termMonths, paymentsMade: termMonths, monthsBehind: 0, totalDue: 0, nextDueDate: null };
    }

    let paymentsDue = 0;
    let nextDueDate = null;

    for (let i = 1; i <= termMonths; i++) {
        let dueDate = new Date(startDate);
        dueDate.setMonth(startDate.getMonth() + i);

        if (startDate.getDate() !== dueDate.getDate()) {
            dueDate.setDate(0); 
            dueDate.setDate(startDate.getDate()); 
        }

        const dateOnlyToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const dateOnlyDue = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
        
        if (dateOnlyToday >= dateOnlyDue) {
            paymentsDue = i; 
        } else {
            nextDueDate = dueDate.toISOString().split('T')[0];
            break; 
        }
    }
    
    let monthsBehind = Math.max(0, paymentsDue - paymentsMade);
    let totalDue = cuotaMensual * monthsBehind;

    if (paymentsDue === termMonths && paymentsMade < termMonths) {
        nextDueDate = null;
    }

    return {
        paymentsDue, 
        paymentsMade: paymentsMade,
        monthsBehind,
        totalDue: totalDue,
        nextDueDate: nextDueDate
    };
}
// ===============================================


// ===============================================
// FUNCI√ìN NUEVA: OBTENER PR√ìXIMAS CUOTAS (PARA CARRUSEL)
// ===============================================
function getUpcomingPayments() {
    const allLoans = DB.get("loans").filter(l => l.status !== 'Pagado');
    const upcomingPayments = [];
    const today = new Date();
    
    for (const loan of allLoans) {
        const risk = calculateLoanRisk(loan);
        
        // Excluir pr√©stamos que est√©n en mora 
        if (risk.monthsBehind > 0) continue; 
        
        // Si no hay mora Y hay una pr√≥xima fecha de vencimiento
        if (risk.nextDueDate) {
            const dueDate = new Date(risk.nextDueDate + 'T00:00:00');
            const diffDays = Math.ceil((dueDate - today) / (1000 * 60 * 60 * 24));
            
            // Solo considerar pagos a vencer en los pr√≥ximos 60 d√≠as
            if (diffDays >= 0 && diffDays <= 60) {
                upcomingPayments.push({
                    loanId: loan.id,
                    clientName: loan.clientName,
                    amount: Number(loan.monthlyPayment),
                    dueDate: risk.nextDueDate,
                    daysLeft: diffDays
                });
            }
        }
    }
    
    // Ordenar por fecha de vencimiento (el m√°s pr√≥ximo primero)
    return upcomingPayments.sort((a, b) => a.daysLeft - b.daysLeft);
}

// ===============================================
// FUNCI√ìN NUEVA: RENDERIZAR CARRUSEL DE PAGOS
// ===============================================
let carouselIndex = 0;

function renderUpcomingPaymentsCarousel() {
    const upcomingPayments = getUpcomingPayments();
    const container = document.getElementById('upcoming-payments-carousel-container');
    
    if (!container) return; // Salir si el contenedor no existe

    if (upcomingPayments.length === 0) {
        container.innerHTML = `
            <div class="card" style="border-left: 5px solid #2ecc71; background: #f0fff0;">
                <h4 style="color:#2ecc71; margin-top:0;">üéâ ¬°Todo al D√≠a!</h4>
                <p>No hay cuotas pr√≥ximas a vencer en los pr√≥ximos 60 d√≠as o todos los pr√©stamos est√°n saldados/en mora.</p>
                <button class="action-btn" style="width: auto; padding: 8px 15px; background: #2ecc71;" onclick="renderCobros()">Ver Cobros Pendientes</button>
            </div>
        `;
        return;
    }
    
    // Generar las tarjetas del carrusel
    const slidesHTML = upcomingPayments.map(p => {
        const dateFormatted = p.dueDate.split('-').reverse().join('/');
        const daysText = p.daysLeft === 0 ? '¬°HOY!' : `en ${p.daysLeft} d√≠as`;
        const color = p.daysLeft <= 7 ? '#e74c3c' : (p.daysLeft <= 30 ? '#f39c12' : '#1c5d99');
        
        return `
            <div class="carousel-item" style="border-left-color: ${color};" 
                 onclick="renderCobros('${p.loanId}')">
                <h4>${p.clientName}</h4>
                <p>Pr√©stamo ID: <b>${p.loanId.toUpperCase().substring(0, 8)}</b></p>
                <div class="carousel-item-footer">
                    <span style="font-weight:bold; font-size:1.4em; color:${color};">${formatCurrency(p.amount)}</span>
                    <span style="text-align:right;">
                        Vence: <b>${dateFormatted}</b><br>
                        <strong style="color:${color};">${daysText}</strong>
                    </span>
                </div>
                <button class="action-btn" style="padding: 8px 15px; margin-top:10px; background:${color};">Registrar Cobro</button>
            </div>
        `;
    }).join('');

    // Estructura completa del carrusel con botones de navegaci√≥n
    container.innerHTML = `
        <div class="carousel-container">
            <div id="carousel-slides" class="carousel-slides">
                ${slidesHTML}
            </div>
            <button id="prev-btn" class="carousel-nav-btn" onclick="moveCarousel(-1)">&#10094;</button>
            <button id="next-btn" class="carousel-nav-btn" onclick="moveCarousel(1)">&#10095;</button>
        </div>
    `;
    
    // Esconder botones en m√≥viles o si hay pocos √≠tems (solo si no se usa scroll)
    if (window.innerWidth < 768 || upcomingPayments.length <= 3) {
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
    } else {
        // En desktop, a√±adimos el control manual si hay m√°s de 3
        updateCarouselButtons();
    }
}

// L√≥gica de movimiento del carrusel (solo para desktop con botones)
function moveCarousel(direction) {
    const slides = document.getElementById('carousel-slides');
    const items = slides.getElementsByClassName('carousel-item');
    if (items.length === 0) return;
    
    const maxIndex = items.length - 1; 
    
    // Calcular el nuevo √≠ndice (m√≠nimo 0, m√°ximo el √∫ltimo √≠ndice)
    carouselIndex = Math.max(0, Math.min(maxIndex, carouselIndex + direction));
    
    // Calcular la posici√≥n de scroll
    // 300px es el ancho aproximado de una tarjeta + gap en desktop (ajustar si es necesario)
    const scrollPosition = carouselIndex * items[0].offsetWidth + (carouselIndex * 15); 
    
    slides.scrollTo({
        left: scrollPosition,
        behavior: 'smooth'
    });
    
    updateCarouselButtons();
}

// Ocultar/Mostrar botones de navegaci√≥n (desktop)
function updateCarouselButtons() {
    const items = document.getElementById('carousel-slides').getElementsByClassName('carousel-item');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (!prevBtn || !nextBtn || items.length === 0) return;

    // Mostrar/Ocultar el bot√≥n anterior
    prevBtn.style.visibility = carouselIndex > 0 ? 'visible' : 'hidden';

    // Mostrar/Ocultar el bot√≥n siguiente (si hay m√°s de 3 items y no estamos en el final)
    nextBtn.style.visibility = (carouselIndex < items.length - 3) ? 'visible' : 'hidden';
}
// ===============================================


// ===============================================
// VISTA: DASHBOARD - LLAMADA AL CARRUSEL
// ===============================================
function calculateLoanPortfolioSummary() {
    const allLoans = DB.get("loans");
    const allCobros = DB.getInitialCobros();
    let netBalancePending = 0; 
    let moraAmount = 0;
    let totalPrincipalLent = 0;

    for (const loan of allLoans) {
        const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
        totalPrincipalLent += Number(loan.amount);

        const totalPaidAmount = allCobros
            .filter(c => c.loanId === loan.id)
            .reduce((sum, current) => sum + Number(current.amount), 0);
        
        const remainingBalance = totalPagar - totalPaidAmount;
        
        if (remainingBalance > 0.01) { 
            netBalancePending += remainingBalance;
        }

        const risk = calculateLoanRisk(loan);
        if (risk.monthsBehind > 0) {
            moraAmount += risk.totalDue; 
        }
    }

    return { netBalancePending, moraAmount, totalPrincipalLent };
}


function renderDashboard(){
  const clients = DB.get("clients").length;
  const cobros = DB.getInitialCobros(); 
  
  const totalGanancias = cobros.reduce((a,b)=> a+Number(b.amount),0); 

  const summary = calculateLoanPortfolioSummary();
  const netBalancePending = summary.netBalancePending; 
  
  const allLoans = DB.get("loans");
  const loansInMora = allLoans.filter(l => calculateLoanRisk(l).monthsBehind > 0); 
  
  let premiumWarning = '';
  if (!trialActivo() && !suscripcionActiva()) {
    premiumWarning = `
      <div class="card" style="border-left: 5px solid #e74c3c; background: #fff0f0; margin-bottom: 20px;">
        <h3 style="color:#e74c3c; margin-top:0;">‚ö†Ô∏è ¬°Tu Per√≠odo de Prueba ha Expirado!</h3>
        <p>Tu aplicaci√≥n est√° ahora en modo limitado. Por favor, haz clic en el bot√≥n **"Suscripci√≥n"** del men√∫ para desbloquear todas las funciones sin restricciones.</p>
        <button class="action-btn" style="background:#e74c3c;" onclick="abrirModal()">Ir a Suscripci√≥n</button>
      </div>
    `;
  } else if (trialActivo()) {
     premiumWarning = `
      <div class="card" style="border-left: 5px solid #f39c12; background: #fff8e1; margin-bottom: 20px;">
        <h3 style="color:#f39c12; margin-top:0;">‚è≥ Per√≠odo de Prueba Activo</h3>
        <p>Te quedan **${diasRestantesTrial()} d√≠as** de prueba. ¬°Aprovecha! Luego, haz clic en el bot√≥n **"Suscripci√≥n"** del men√∫ para mantener tu acceso sin l√≠mites.</p>
      </div>
    `;
  }


  main.innerHTML = `
    <h2>Resumen de Pr√©stamos üìà</h2>
    
    ${premiumWarning}
    
    <h3>Pr√≥ximas Cuotas a Vencer (60 d√≠as)</h3>
    <div id="upcoming-payments-carousel-container">
        </div>

    <div class="dashboard-cards-container">
        
        <div class="card" style="border-left: 5px solid #2980b9;">
            <h3>Clientes Totales</h3>
            <p style="font-size:36px; font-weight:bold;">${clients}</p>
            <p style="margin:0; font-size:0.9em; color:#888;">Total de personas registradas.</p>
        </div>
        
        <div class="card" style="border-left: 5px solid #2ecc71;">
            <h3>Ganancias Recibidas</h3>
            <p style="font-size:36px; font-weight:bold;">${formatCurrency(totalGanancias)}</p>
            <p style="margin:0; font-size:0.9em; color:#888;">Monto total de cobros hist√≥ricos.</p>
        </div>

        <div class="card" style="border-left: 5px solid #1c5d99;">
            <h3>Potencial de Ingreso</h3>
            <p style="font-size:36px; font-weight:bold;">${formatCurrency(netBalancePending)}</p>
            <p style="margin:0; font-size:0.9em; color:#888;">Total (Ppal + Inter√©s) por cobrar.</p>
        </div>
        
        <div class="card" style="border-left: 5px solid ${loansInMora.length > 0 ? '#e74c3c' : '#2ecc71'};">
            <h3>Pr√©stamos en Mora ‚ö†Ô∏è</h3>
            <p style="font-size:36px; font-weight:bold; color: ${loansInMora.length > 0 ? '#e74c3c' : '#2ecc71'};">
                ${loansInMora.length}
            </p>
            <p style="margin:0; font-size:0.9em; color:#888;">Pr√©stamos con 1+ cuota de atraso.</p>
        </div>
    </div>

    <h3>Distribuci√≥n de Capital Prestado</h3>
    <div class="card">
        <div style="max-height: 400px;"> 
            <canvas id="loanDistributionChart"></canvas>
        </div>
    </div>
  `;
  
  // LLAMADA CLAVE PARA RENDERIZAR EL CARRUSEL
  renderUpcomingPaymentsCarousel();
  
  renderLoanDistributionChart();
}

function renderLoanDistributionChart() {
    const loans = DB.get("loans");
    if (loans.length === 0) return;

    const clientAmounts = {};
    loans.forEach(loan => {
        clientAmounts[loan.clientName] = (clientAmounts[loan.clientName] || 0) + Number(loan.amount);
    });

    const labels = Object.keys(clientAmounts);
    const data = Object.values(clientAmounts);
    
    const getColors = (count) => {
        const colors = [
            '#1c5d99', '#4a6d4a', '#f39c12', '#e74c3c', '#9b59b6', 
            '#34495e', '#1abc9c', '#f1c40f', '#2980b9', '#c0392b'
        ];
        return Array.from({length: count}, (_, i) => colors[i % colors.length]);
    };

    new Chart(document.getElementById('loanDistributionChart'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monto Prestado',
                data: data,
                backgroundColor: getColors(labels.length),
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, 
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Monto Principal Prestado por Cliente'
                }
            }
        }
    });
}
// ===============================================
// INICIO: FUNCIONES DE CLIENTES, PR√âSTAMOS, COBROS, etc.
// (Se mantienen las funciones de manejo de datos y vistas)
// ===============================================

function calculateTotalLoanAmount(clientId) {
    const loans = DB.get("loans");
    return loans
        .filter(l => l.clientId === clientId)
        .reduce((sum, current) => sum + Number(current.amount), 0);
}


function renderClients(){
  main.innerHTML = `
    <h2>Clientes üë•</h2>
    <div style="margin-bottom:20px;">
        <input id="client-search" placeholder="Buscar por Nombre o C√©dula..." class="form-input" onkeyup="refreshClientsList(this.value)">
    </div>
    
    <div class="card" style="background: #f0f7ff; border: 1px solid #d0e8ff;">
        <h3 style="margin-top:0;">Agregar Nuevo Cliente</h3>
        <div style="display:grid; gap:10px;">
            <input id="client-name" placeholder="Nombre (Requerido)" class="form-input">
            <input type="number" id="client-cedula" placeholder="C√©dula/ID (Requerido)" class="form-input">
            <input id="client-address" placeholder="Direcci√≥n Residencial" class="form-input">
            <input type="tel" id="client-phone-main" placeholder="Tel√©fono Principal" class="form-input"> 
            <input type="tel" id="client-phone-mobile" placeholder="Celular" class="form-input">
            <button class="action-btn" onclick="addClient()">Agregar Cliente</button>
        </div>
    </div>
    
    <div id="no-clients-warning" style="display:none; text-align:center; padding:20px; border-radius:10px; background:#fff3cd; border:1px solid #ffeeba; color:#856404; margin-bottom:20px;">
        ‚ö†Ô∏è **No hay clientes registrados.** Por favor, a√±ada uno usando el formulario de arriba.
    </div>

    <div id="clients-list"></div>
  `;
  refreshClientsList();
}

function addClient(){
  if (!trialActivo() && !suscripcionActiva()) {
    showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para agregar nuevos clientes.", 'error');
    abrirModal(); 
    return;
  }
  
  const name = document.getElementById("client-name").value.trim();
  const cedula = document.getElementById("client-cedula").value.trim();
  const address = document.getElementById("client-address").value.trim();
  const phoneMain = document.getElementById("client-phone-main").value.trim();
  const phoneMobile = document.getElementById("client-phone-mobile").value.trim();
  
  if(!name || !cedula) {
    showToast("Nombre y C√©dula/ID son requeridos", 'error'); 
    return;
  }
  
  const all = DB.get("clients");
  
  const isDuplicate = all.some(client => client.cedula === cedula);
  if (isDuplicate) {
    showToast(`Error: Ya existe un cliente con la C√©dula/ID ${cedula}.`, 'error');
    return;
  }

  all.push({
    id: genId(), 
    name, 
    cedula,             
    address,            
    phoneMain,          
    phoneMobile         
  });
  DB.set("clients", all);
  
  document.getElementById("client-name").value = '';
  document.getElementById("client-cedula").value = '';
  document.getElementById("client-address").value = '';
  document.getElementById("client-phone-main").value = '';
  document.getElementById("client-phone-mobile").value = '';
  
  refreshClientsList();
  showToast("Cliente agregado correctamente", 'success'); 
}

function refreshClientsList(searchTerm = ''){
  let list = DB.get("clients");
  const box = document.getElementById("clients-list");
  const warningBox = document.getElementById("no-clients-warning");
  
  if(searchTerm.trim()){
    const term = searchTerm.toLowerCase().trim();
    list = list.filter(c => 
      c.name.toLowerCase().includes(term) || 
      c.cedula.toLowerCase().includes(term)
    );
  }

  if(list.length===0){ 
    box.innerHTML=`<p style="text-align:center; padding:20px;">${searchTerm ? 'No se encontraron clientes que coincidan con la b√∫squeda.' : ''}</p>`; 
    if (!searchTerm && warningBox) {
        warningBox.style.display = 'block'; 
    } else if (warningBox) {
        warningBox.style.display = 'none';
    }
    return; 
  } else if (warningBox) {
      warningBox.style.display = 'none';
  }
  
  box.innerHTML = list.map(c=>{
    const totalPrestado = calculateTotalLoanAmount(c.id);

    return `
      <div class="card" id="client-card-${c.id}">
          <div id="client-view-${c.id}">
              <h4 style="margin:0 0 5px 0; color:#1c5d99;">${c.name}</h4>
              C√©dula: ${c.cedula || 'N/A'}<br>
              Dir: ${c.address || 'N/A'}<br>
              Total Capital Prestado: <b style="color:#2ecc71;">${formatCurrency(totalPrestado)}</b><br>
              Tel: ${c.phoneMain || 'N/A'} / Cel: ${c.phoneMobile || 'N/A'}<br><br>
              
              <div style="display:flex; gap:10px;">
                  <button class="action-btn" style="flex:1; background:#f39c12;" onclick="prepareEdit('${c.id}')">‚úèÔ∏è Editar</button>
                  <button class="action-btn" style="flex:1; background:#e74c3c;" onclick="deleteClient('${c.id}')">üóëÔ∏è Eliminar</button>
              </div>
          </div>
          <div id="client-edit-${c.id}" style="display:none;">
          </div>
      </div>
    `;
  }).join("");
}

function deleteClient(id) {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para editar o eliminar datos.", 'error');
        abrirModal();
        return;
    }
    
    if (!confirm("ADVERTENCIA: ¬øEst√° seguro de que desea eliminar a este cliente? Esto eliminar√° PERMANENTEMENTE todos sus pr√©stamos y el historial de cobros asociados.")) return;

    let allClients = DB.get("clients");
    allClients = allClients.filter(c => c.id !== id);
    DB.set("clients", allClients);
    
    let allLoans = DB.get("loans");
    const loansToDelete = allLoans.filter(l => l.clientId === id); 
    allLoans = allLoans.filter(l => l.clientId !== id);
    DB.set("loans", allLoans);

    let allCobros = DB.getInitialCobros();
    const loanIdsToDelete = loansToDelete.map(l => l.id);
    
    allCobros = allCobros.filter(c => !loanIdsToDelete.includes(c.loanId));
    DB.set("cobros", allCobros);

    const searchTerm = document.getElementById("client-search") ? document.getElementById("client-search").value : '';
    refreshClientsList(searchTerm);
    
    showToast("Cliente, pr√©stamos y cobros asociados eliminados correctamente.", 'warning');
}


function prepareEdit(id) {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para editar datos.", 'error');
        abrirModal();
        return;
    }
    
    const client = DB.get("clients").find(c => c.id === id);
    if (!client) return;

    const totalPrestado = calculateTotalLoanAmount(id);

    document.getElementById(`client-view-${id}`).style.display = 'none';
    const editBox = document.getElementById(`client-edit-${id}`);
    editBox.style.display = 'block';

    editBox.innerHTML = `
        <input id="edit-name-${id}" value="${client.name}" placeholder="Nombre" class="form-input" style="margin-bottom:5px;">
        <input type="number" id="edit-cedula-${id}" value="${client.cedula}" placeholder="C√©dula" class="form-input" style="margin-bottom:5px;">
        <input id="edit-address-${id}" value="${client.address || ''}" placeholder="Direcci√≥n Residencial" class="form-input" style="margin-bottom:5px;">
        <input type="tel" id="edit-phone-main-${id}" value="${client.phoneMain || ''}" placeholder="Tel√©fono Principal" class="form-input" style="margin-bottom:5px;">
        <input type="tel" id="edit-phone-mobile-${id}" value="${client.phoneMobile || ''}" placeholder="Celular" class="form-input" style="margin-bottom:10px;">
        
        <p style="margin: 0 0 10px 0; padding:10px; background:#f0f0f0; border-radius:5px;">
            **Capital Total Prestado:** <span style="font-weight:bold; color:#1c5d99;">${formatCurrency(totalPrestado)}</span> 
            (No editable aqu√≠. Se gestiona en "Pr√©stamos")
        </p>

        <div style="display:flex; gap:10px;">
            <button class="action-btn" style="flex:1; background:#2ecc71;" onclick="saveClient('${id}')">üíæ Guardar Cambios</button>
            <button class="action-btn" style="flex:1; background:#95a5a6;" onclick="cancelEdit('${id}')">‚ùå Cancelar</button>
        </div>
    `;
}

function cancelEdit(id) {
    document.getElementById(`client-view-${id}`).style.display = 'block';
    document.getElementById(`client-edit-${id}`).style.display = 'none';
    document.getElementById(`client-edit-${id}`).innerHTML = ''; 
}

function saveClient(id) {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para editar datos.", 'error');
        abrirModal();
        return;
    }
    
    const name = document.getElementById(`edit-name-${id}`).value.trim();
    const cedula = document.getElementById(`edit-cedula-${id}`).value.trim();
    const address = document.getElementById(`edit-address-${id}`).value.trim();
    const phoneMain = document.getElementById(`edit-phone-main-${id}`).value.trim();
    const phoneMobile = document.getElementById(`edit-phone-mobile-${id}`).value.trim();

    if(!name || !cedula) {
        showToast("Nombre y C√©dula son requeridos para guardar.", 'error'); 
        return;
    }

    let all = DB.get("clients");
    const index = all.findIndex(c => c.id === id);
    if (index === -1) return;
    
    const isDuplicate = all.some(c => c.cedula === cedula && c.id !== id);
    if (isDuplicate) {
        showToast(`Error: Ya existe otro cliente con la C√©dula/ID ${cedula}.`, 'error');
        return;
    }


    all[index] = {
        id: id, 
        name, 
        cedula,             
        address,            
        phoneMain,          
        phoneMobile
    };

    DB.set("clients", all);
    
    const searchTerm = document.getElementById("client-search") ? document.getElementById("client-search").value : '';
    refreshClientsList(searchTerm);
    showToast("Cliente guardado correctamente.", 'success'); 
}

// VISTA: PR√âSTAMOS
function renderLoans() {
    const settings = DB.getSettings();
  main.innerHTML = `
    <h2>Pr√©stamos üíµ</h2>
    
    <div class="card" style="text-align:left; background: #f0f7ff; border: 1px solid #d0e8ff;">
        <h3>Registrar Nuevo Pr√©stamo (Cuotas Fijas)</h3>
        
        <label for="loan-client" style="display:block; font-weight:bold; margin-bottom:5px;">Cliente:</label>
        <select id="loan-client" class="form-input" style="margin-bottom:15px;">
            <option value="">-- Seleccione un Cliente --</option>
        </select>
        
        <label for="loan-amount" style="display:block; font-weight:bold; margin-bottom:5px;">Monto del pr√©stamo (${settings.currencySymbol}):</label>
        <input type="number" id="loan-amount" placeholder="Monto Principal (${settings.currencySymbol})" class="form-input" value="10000" min="1" style="margin-bottom:15px;">
        
        <label for="loan-interest-base" style="display:block; font-weight:bold; margin-bottom:5px;">Porcentaje de inter√©s base (%) - Para 3 meses:</label>
        <input type="number" id="loan-interest-base" placeholder="Tasa Base (%)" class="form-input" value="${settings.baseInterestRate}" min="0" step="0.1" style="margin-bottom:15px;">
        
        <label for="loan-term" style="display:block; font-weight:bold; margin-bottom:5px;">Plazo (meses):</label>
        <input type="number" id="loan-term" placeholder="Plazo (Meses)" class="form-input" value="3" min="1" style="margin-bottom:15px;">
        
        <button class="action-btn" onclick="calculateAndSaveLoan()">‚ûï Calcular y Registrar Pr√©stamo</button>
        
        <div id="calculator-summary" style="margin-top: 15px; padding: 15px; border-radius: 8px; background: #fff; border: 1px dashed #ccc;"></div>
    </div>
    
    <div style="margin-top:20px;">
        <h3>Pr√©stamos Activos y Pagados</h3>
        <div id="loans-list">
            </div>
    </div>
  `;
  populateClientSelect(); 
  refreshLoanList();      
}

function populateClientSelect() {
    const clients = DB.get("clients");
    const select = document.getElementById("loan-client");

    if (clients.length === 0) {
        select.innerHTML = '<option value="" disabled>No hay clientes para prestar</option>';
        return;
    }

    select.innerHTML = '<option value="">-- Seleccione un Cliente --</option>'; 
    
    clients.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.name} (C√©dula: ${c.cedula})`;
        select.appendChild(option);
    });
}

function calculateAndSaveLoan() {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para registrar nuevos pr√©stamos.", 'error');
        abrirModal();
        return;
    }
    
    const clientId = document.getElementById("loan-client").value;
    const P = Number(document.getElementById("loan-amount").value); 
    const interesBase = Number(document.getElementById("loan-interest-base").value); 
    const n = Number(document.getElementById("loan-term").value); 
    
    if (!clientId) {
        showToast("Por favor, seleccione un cliente.", 'error'); 
        return;
    }
    if (P <= 0 || interesBase < 0 || n <= 0) {
        showToast("Por favor, complete todos los campos de la calculadora correctamente con valores positivos.", 'error'); 
        return;
    }

    const client = DB.get("clients").find(c => c.id === clientId);
    if (!client) {
        showToast("Cliente no encontrado.", 'error'); 
        return;
    }

    const totalInteres = P * (interesBase / 100) * (n / 3);
    const totalPagar = P + totalInteres;
    const cuotaMensual = totalPagar / n;

    let resultadoHTML = `
        <h4 style="margin-top:0;">Resumen del Pr√©stamo</h4>
        <p style="border-top: 1px solid #ccc; padding-top: 10px;">
            <strong>Monto Pr√©stamo:</strong> ${formatCurrency(P)}<br>
            <strong>Inter√©s Total:</strong> ${formatCurrency(totalInteres)}<br>
            <strong>Total a Pagar:</strong> ${formatCurrency(totalPagar)}<br>
            <strong style="color:#1c5d99; font-size: 1.2em;">Cuota Mensual Fija: ${formatCurrency(cuotaMensual)}</strong>
        </p>
    `;
    document.getElementById('calculator-summary').innerHTML = resultadoHTML;
    
    const newLoan = {
        id: genId(),
        clientId: clientId,
        clientName: client.name,
        amount: P.toFixed(2), 
        interestRateBase: interesBase,
        termMonths: n,
        monthlyPayment: cuotaMensual.toFixed(2),
        totalInterest: totalInteres.toFixed(2),
        date: new Date().toLocaleDateString(),
        status: 'Activo',
        paymentsMade: 0, 
        totalPaidAmount: 0, 
        startDate: new Date().toISOString().split('T')[0] 
    };

    const allLoans = DB.get("loans");
    allLoans.push(newLoan);
    DB.set("loans", allLoans);

    showToast(`Pr√©stamo registrado. Cuota Mensual: ${formatCurrency(newLoan.monthlyPayment)}`, 'success'); 
    
    const settings = DB.getSettings();
    document.getElementById("loan-amount").value = '10000';
    document.getElementById("loan-interest-base").value = settings.baseInterestRate;
    document.getElementById("loan-term").value = '3';
    document.getElementById("loan-client").value = '';
    document.getElementById('calculator-summary').innerHTML = ''; 

    refreshLoanList(); 
}

function deleteLoan(id) {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para editar o eliminar datos.", 'error');
        abrirModal();
        return;
    }
    
    if (!confirm("ADVERTENCIA: ¬øEst√° seguro de que desea eliminar este PR√âSTAMO? Esto eliminar√° PERMANENTEMENTE este pr√©stamo y todos los cobros asociados a √©l.")) return;

    let allLoans = DB.get("loans");
    allLoans = allLoans.filter(l => l.id !== id);
    DB.set("loans", allLoans);
    
    let allCobros = DB.getInitialCobros();
    allCobros = allCobros.filter(c => c.loanId !== id);
    DB.set("cobros", allCobros);

    refreshLoanList(); 
    
    if (document.getElementById('pending-payments-list')) {
        refreshPendingPayments();
    }

    showToast("Pr√©stamo y sus cobros asociados eliminados correctamente.", 'warning'); 
}


function refreshLoanList() {
    const loans = DB.get("loans");
    const box = document.getElementById("loans-list");
    
    if (loans.length === 0) {
        box.innerHTML = '<p style="text-align:center;">No hay pr√©stamos activos registrados.</p>';
        return;
    }

    const tableRows = loans.map(l => {
        const totalPagar = Number(l.amount) + Number(l.totalInterest);
        const paidPercentage = (l.totalPaidAmount / totalPagar) * 100;
        const risk = calculateLoanRisk(l);
        const statusColor = risk.monthsBehind > 0 ? '#e74c3c' : (l.status === 'Pagado' ? '#2ecc71' : '#f39c12');
        const statusText = risk.monthsBehind > 0 ? `Mora (${risk.monthsBehind} meses)` : l.status;
        const progressStyle = paidPercentage > 100 ? 100 : paidPercentage;
        
        let nextDueText = 'N/A';
        if (l.status === 'Pagado') {
            nextDueText = 'Pr√©stamo saldado.';
        } else if (risk.monthsBehind > 0) {
            nextDueText = `<span style="color:red; font-weight:bold;">¬°En Mora!</span>`;
        } else if (risk.nextDueDate) {
             nextDueText = risk.nextDueDate.split('-').reverse().join('/'); 
        } else {
             nextDueText = 'Vencimiento Expirado';
        }

        return `
            <div class="card" style="border-left: 5px solid ${statusColor};">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <h4 style="margin:0; color:#1c5d99;">${l.clientName}</h4>
                    <span style="background:${statusColor}; color:white; padding: 5px 10px; border-radius:5px; font-size:0.9em; font-weight:bold;">${statusText}</span>
                </div>
                <hr style="border: 0; height: 1px; background: #eee; margin: 10px 0;">
                <p style="margin: 5px 0; font-size:1.1em;">
                    Monto Principal: <b>${formatCurrency(l.amount)}</b><br>
                    Cuota Mensual: <b>${formatCurrency(l.monthlyPayment)}</b><br>
                    Pr√≥ximo Vencimiento: <b>${nextDueText}</b>
                </p>
                <p style="margin: 5px 0;">
                    Pagado: ${formatCurrency(l.totalPaidAmount)} / Total: ${formatCurrency(totalPagar)} 
                    (${l.paymentsMade}/${l.termMonths} cuotas)
                </p>
                
                <div style="background:#eee; border-radius:5px; height:10px; margin: 10px 0;">
                    <div style="background:${statusColor}; width:${progressStyle}%; height:10px; border-radius:5px;"></div>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="action-btn" style="flex:1; background:#1c5d99;" onclick="renderCobros('${l.id}')">üí∞ Registrar Cobro</button>
                    <button class="action-btn" style="flex:1; background:#e74c3c;" onclick="deleteLoan('${l.id}')">üóëÔ∏è Eliminar</button>
                </div>
            </div>
        `;
    }).join("");
    box.innerHTML = `<div id="loans-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">${tableRows}</div>`;
}

// VISTA: COBROS (PAGOS)
function renderCobros(loanIdToSelect = null) {
    const settings = DB.getSettings();
    main.innerHTML = `
        <h2>Registro de Cobros üí∞</h2>
        
        <div class="card" style="text-align:left; background: #f0f7ff; border: 1px solid #d0e8ff;">
            <h3>Registrar Pago a Pr√©stamo</h3>
            
            <label for="payment-loan-id" style="display:block; font-weight:bold; margin-bottom:5px;">Seleccionar Pr√©stamo:</label>
            <select id="payment-loan-id" class="form-input" style="margin-bottom:15px;" onchange="updatePaymentDetails()">
                <option value="">-- Seleccione un Pr√©stamo --</option>
            </select>

            <div id="loan-summary-payment" style="margin-bottom:15px; background:#fff; padding:15px; border-radius:8px; border:1px solid #eee;">
                Seleccione un pr√©stamo para ver el resumen de pago.
            </div>

            <label for="payment-amount" style="display:block; font-weight:bold; margin-bottom:5px;">Monto del Pago (${settings.currencySymbol}):</label>
            <input type="number" id="payment-amount" placeholder="Monto a Cobrar (${settings.currencySymbol})" class="form-input" min="0.01" step="0.01" style="margin-bottom:15px;">
            

            <button class="action-btn" onclick="registerPayment()">‚úÖ Registrar Cobro</button>
        </div>

        <div class="card" style="margin-top: 20px; background: #ffe0f0; border: 1px solid #f0cccc;">
             <h3>Generar Factura Manual</h3>
             <p>Seleccione un cobro del historial para generar o ver la factura retroactivamente.</p>
             <label for="invoice-cobro-id" style="display:block; font-weight:bold; margin-bottom:5px;">Seleccionar Cobro:</label>
             <select id="invoice-cobro-id" class="form-input" style="margin-bottom:15px;">
                <option value="">-- Seleccione un Cobro del Historial --</option>
             </select>
             <div style="display:flex; gap:10px;">
                <button class="action-btn" style="flex:1; background:#8e44ad;" onclick="generateInvoiceFromSelect(true)">üëÅÔ∏è Ver Factura PDF</button>
                <button class="action-btn" style="flex:1; background:#2ecc71;" onclick="generateInvoiceFromSelect(false)">‚¨áÔ∏è Descargar PDF</button>
             </div>
        </div>


        <div style="margin-top:20px;">
            <h3>Pagos Pendientes y en Mora</h3>
            <div id="pending-payments-list"></div>
        </div>
    `;

    populateLoanSelect(loanIdToSelect);
    populateCobroSelectForInvoice(); 
    refreshPendingPayments();
}

function populateLoanSelect(loanIdToSelect) {
    const loans = DB.get("loans").filter(l => l.status !== 'Pagado');
    const select = document.getElementById("payment-loan-id");
    
    select.innerHTML = '<option value="">-- Seleccione un Pr√©stamo --</option>'; 
    
    loans.forEach(l => {
        const totalPagar = Number(l.amount) + Number(l.totalInterest);
        const remaining = totalPagar - Number(l.totalPaidAmount);

        const option = document.createElement('option');
        option.value = l.id;
        option.textContent = `${l.clientName} (Resta: ${formatCurrency(remaining)})`;
        select.appendChild(option);
    });
    
    if (loanIdToSelect && select.querySelector(`option[value="${loanIdToSelect}"]`)) {
        select.value = loanIdToSelect;
        updatePaymentDetails(); 
    }
}

function updatePaymentDetails() {
    const loanId = document.getElementById("payment-loan-id").value;
    const summaryBox = document.getElementById("loan-summary-payment");
    const paymentAmountInput = document.getElementById("payment-amount");
    
    summaryBox.innerHTML = 'Seleccione un pr√©stamo para ver el resumen de pago.';
    paymentAmountInput.value = ''; 

    if (!loanId) return;

    const loan = DB.get("loans").find(l => l.id === loanId);
    if (!loan) return;

    const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
    const remainingBalance = totalPagar - Number(loan.totalPaidAmount);
    const cuotaMensual = Number(loan.monthlyPayment);
    const risk = calculateLoanRisk(loan);
    
    let moraText = '';
    
    if (remainingBalance <= 0.01) { 
        paymentAmountInput.value = '0.00';
        moraText = '<p style="color:#2ecc71; font-weight:bold; margin: 5px 0;">Pr√©stamo completamente saldado.</p>';
    } else if (risk.monthsBehind > 0) {
        moraText = `<p style="color:#e74c3c; font-weight:bold; margin: 5px 0;">¬°En Mora! Adeuda ${risk.monthsBehind} cuota(s) por un total de ${formatCurrency(risk.totalDue)}.</p>`;
        paymentAmountInput.value = risk.totalDue.toFixed(2); 
    } else if (remainingBalance > 0 && remainingBalance < cuotaMensual) {
        paymentAmountInput.value = remainingBalance.toFixed(2); 
    } else {
        paymentAmountInput.value = cuotaMensual.toFixed(2); 
    }


    summaryBox.innerHTML = `
        <p style="margin: 5px 0;">Cliente: <b>${loan.clientName}</b></p>
        <p style="margin: 5px 0;">Cuota Fija: <b>${formatCurrency(cuotaMensual)}</b></p>
        <p style="margin: 5px 0;">Saldo Restante: <b>${formatCurrency(remainingBalance)}</b></p>
        ${moraText}
    `;
}

function registerPayment() {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para registrar cobros.", 'error');
        abrirModal();
        return;
    }
    
    const loanId = document.getElementById("payment-loan-id").value;
    const amount = Number(document.getElementById("payment-amount").value);
    
    if (!loanId || amount <= 0) {
        showToast("Seleccione un pr√©stamo e ingrese un monto v√°lido.", 'error'); 
        return;
    }

    let allLoans = DB.get("loans");
    const loanIndex = allLoans.findIndex(l => l.id === loanId);
    if (loanIndex === -1) {
        showToast("Pr√©stamo no encontrado.", 'error'); 
        return;
    }

    const loan = allLoans[loanIndex];
    const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
    const remainingBalance = totalPagar - Number(loan.totalPaidAmount);
    const cuotaMensual = Number(loan.monthlyPayment);
    
    if (amount > remainingBalance + 0.01) { 
        if (!confirm(`El monto de ${formatCurrency(amount)} es mayor al saldo pendiente (${formatCurrency(remainingBalance)}). ¬øDesea registrar el pago igual? El saldo restante se ajustar√° a cero.`)) {
            return;
        }
    }
    
    const oldTotalPaidAmount = Number(loan.totalPaidAmount);
    const oldPaymentsMade = Math.floor(oldTotalPaidAmount / cuotaMensual); // Estado antes del pago

    let allCobros = DB.getInitialCobros();
    const newCobro = {
        id: genId(),
        loanId: loanId,
        clientName: loan.clientName,
        amount: amount.toFixed(2), 
        date: new Date().toLocaleDateString(),
        fullDateTime: new Date().toISOString()
    };
    allCobros.push(newCobro);
    DB.set("cobros", allCobros);

    loan.totalPaidAmount = oldTotalPaidAmount + amount;
    loan.paymentsMade = Math.floor(loan.totalPaidAmount / cuotaMensual);

    const newRemaining = totalPagar - loan.totalPaidAmount;
    if (newRemaining <= 0.01) { 
        loan.status = 'Pagado';
        loan.totalPaidAmount = totalPagar; 
        loan.paymentsMade = Number(loan.termMonths); 
    } else {
        loan.status = 'Activo'; 
    }
    
    allLoans[loanIndex] = loan;
    DB.set("loans", allLoans);

    showToast(`Cobro de ${formatCurrency(amount)} registrado para ${loan.clientName}.`, 'success'); 
    
    if (confirm("Cobro exitoso. ¬øDesea ver y descargar la factura del pago en PDF?")) {
        // Se pasa el estado anterior para un c√°lculo exacto del recibo
        viewInvoicePDF(newCobro.id, {
            oldTotalPaidAmount,
            oldPaymentsMade
        }); 
    }

    document.getElementById("payment-amount").value = '';
    document.getElementById("payment-loan-id").value = '';
    document.getElementById("loan-summary-payment").innerHTML = 'Seleccione un pr√©stamo para ver el resumen de pago.';
    populateLoanSelect();
    populateCobroSelectForInvoice(); 
    refreshPendingPayments();
    
    // Si la vista actual es el Dashboard, refrescarlo para actualizar el carrusel y las tarjetas
    if(document.getElementById('loanDistributionChart')) {
        renderDashboard();
    }
}

// FUNCIONES DE FACTURACI√ìN PDF
let currentCobroId = null; 

function populateCobroSelectForInvoice() {
    const allCobros = DB.getInitialCobros().sort((a, b) => new Date(b.fullDateTime) - new Date(a.fullDateTime)); 
    const select = document.getElementById("invoice-cobro-id");
    
    if (!select) return; 

    select.innerHTML = '<option value="">-- Seleccione un Cobro del Historial --</option>'; 
    
    allCobros.slice(0, 100).forEach(c => { 
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.date} - ${c.clientName} (${formatCurrency(c.amount)})`;
        select.appendChild(option);
    });
}

function generateInvoiceFromSelect(viewOnly) {
    const cobroId = document.getElementById("invoice-cobro-id").value;
    if (!cobroId) {
        showToast("Por favor, seleccione un cobro del historial.", 'error'); 
        return;
    }
    
    if (viewOnly) {
        viewInvoicePDF(cobroId); 
    } else {
        generateInvoicePDF(cobroId); 
    }
}

function createInvoiceDocument(cobroId, previousState = {}) {
    const cobro = DB.getInitialCobros().find(c => c.id === cobroId);
    if (!cobro) { 
        showToast("Error: Cobro no encontrado para la factura.", 'error'); 
        return null; 
    }

    const loan = DB.get("loans").find(l => l.id === cobro.loanId);
    if (!loan) { 
        showToast("Error: Pr√©stamo asociado no encontrado para la factura.", 'error'); 
        return null; 
    }
    
    const client = DB.get("clients").find(cl => cl.id === loan.clientId) || { 
        name: loan.clientName, 
        cedula: 'N/A', 
        phoneMain: 'N/A', 
        phoneMobile: 'N/A', 
        address: 'N/A' 
    };
    
    const settings = DB.getSettings();
    const amountPaid = Number(cobro.amount);
    const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
    const cuotaMensual = Number(loan.monthlyPayment);
    
    const isStateProvided = previousState.oldTotalPaidAmount !== undefined;

    let totalPaidBefore = 0;
    let paymentsMadeBefore = 0;
    
    if (!isStateProvided) {
        const allCobrosForLoan = DB.getInitialCobros()
            .filter(c => c.loanId === loan.id)
            .sort((a, b) => new Date(a.fullDateTime) - new Date(b.fullDateTime));
        
        for (const c of allCobrosForLoan) {
            if (c.id === cobro.id) break; 
            totalPaidBefore += Number(c.amount);
        }
        paymentsMadeBefore = Math.floor(totalPaidBefore / cuotaMensual);

    } else {
        totalPaidBefore = previousState.oldTotalPaidAmount;
        paymentsMadeBefore = previousState.oldPaymentsMade;
    }
    
    const remainingBalanceBefore = totalPagar - totalPaidBefore; 
    
    const oldRisk = calculateLoanRisk({ 
        ...loan, 
        totalPaidAmount: totalPaidBefore, 
        paymentsMade: paymentsMadeBefore 
    });
    
    const moraPagada = Math.min(amountPaid, oldRisk.totalDue);
    
    let abonoPrincipalInteres = amountPaid - moraPagada; 
    
    let abonoProximaCuota = 0;
    let abonoNormal = 0; 

    if (abonoPrincipalInteres > 0) {
        abonoNormal = Math.min(cuotaMensual, abonoPrincipalInteres);
        abonoProximaCuota = Math.max(0, abonoPrincipalInteres - abonoNormal);
    }
    
    abonoProximaCuota = Math.max(0, abonoProximaCuota);
    
    const remainingBalanceAfter = totalPagar - (totalPaidBefore + amountPaid);
    const paymentsMadeAfter = Math.floor((totalPaidBefore + amountPaid) / cuotaMensual); 


    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth(); 
    let y = 15; 

    doc.setFontSize(18);
    doc.setTextColor(28, 93, 153); 
    doc.text("RECIBO DE PAGO", pageWidth / 2, y, { align: "center" });
    y += 10;
    
    doc.setFontSize(10);
    doc.setTextColor(51, 51, 51);
    doc.text("Presta Bill S.A. (Sistema de Pr√©stamos)", pageWidth / 2, y, { align: "center" });
    y += 5;
    doc.text("Tel: N/A - Dir: N/A", pageWidth / 2, y, { align: "center" });
    y += 10;
    
    doc.setDrawColor(200, 200, 200);
    doc.line(10, y, pageWidth - 10, y);
    y += 5;

    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);

    const marginLeft = 10;
    const columnWidth = (pageWidth - 20) / 2; 
    const col1X = marginLeft;
    const col2X = marginLeft + columnWidth + 5; 

    function writeRow(leftText, rightText) {
        doc.text(leftText, col1X, y);
        doc.text(rightText, col2X + columnWidth - 5, y, { align: "right" }); 
        y += 7; 
    }

    writeRow(`Recibo No: ${cobro.id.toUpperCase().substring(0, 8)}`, 
             `Fecha: ${cobro.date}`);

    writeRow(`Cliente: ${client.name}`, 
             `C√©dula: ${client.cedula || 'N/A'}`);

    writeRow(`Pr√©stamo ID: ${loan.id.toUpperCase().substring(0, 8)}`, 
             `Cuota Mensual Fija: ${formatCurrency(cuotaMensual)}`);

    writeRow(`Monto Principal: ${formatCurrency(loan.amount)}`, 
             `Total a Pagar (Ppal + Int): ${formatCurrency(totalPagar)}`);

    y += 5; 

    doc.setDrawColor(200, 200, 200);
    doc.line(10, y, pageWidth - 10, y);
    y += 5;

    let desgloseData = [
        ...(moraPagada > 0 ? [["Mora Atrasada Cubierta:", formatCurrency(moraPagada)]] : []),
        ["Abono a Cuota Normal:", formatCurrency(abonoNormal)],
        ...(abonoProximaCuota > 0 ? [["Aporte Extra/Adelanto Cuota:", formatCurrency(abonoProximaCuota)]] : []),
        ["--------------------------------", "--------------------------------"],
        ["MONTO TOTAL DE ESTE COBRO:", formatCurrency(amountPaid)],
    ];
    
    doc.autoTable({
        startY: y,
        head: [['Desglose del Pago', 'Monto']],
        body: desgloseData,
        theme: 'striped',
        styles: { fontSize: 10, cellPadding: 3 },
        headStyles: { fillColor: [44, 62, 80], textColor: 255 },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 100 },
            1: { halign: 'right', fontStyle: 'bold' } 
        },
        didParseCell: function(data) {
            if (data.row.index === desgloseData.length - 1) {
                data.cell.styles.fillColor = [220, 240, 220]; 
            }
        },
        willDrawCell: function(data) {
            if (data.row.index === desgloseData.length - 1 && data.section === 'body') {
                doc.setFontSize(12);
                doc.setTextColor(46, 204, 113); 
            } else if (data.section === 'body') {
                 doc.setFontSize(10);
                 doc.setTextColor(0, 0, 0);
            }
        }
    });
    
    y = doc.autoTable.previous.finalY + 5;

    const finalData = [
        ["Saldo Pendiente ANTES de este Pago:", formatCurrency(remainingBalanceBefore)],
        ["SALDO PENDIENTE DESPU√âS del Pago:", formatCurrency(remainingBalanceAfter)],
        ["Cuotas Pagadas (Acumulado):", `${paymentsMadeAfter} de ${loan.termMonths}`]
    ];
    
    doc.autoTable({
        startY: y,
        head: [['Estado del Pr√©stamo', 'Monto/Valor']],
        body: finalData,
        theme: 'plain',
        styles: { fontSize: 10, cellPadding: 3 },
        headStyles: { fillColor: [28, 93, 153], textColor: 255 },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 100 },
            1: { halign: 'right', fontStyle: 'bold' } 
        },
        didParseCell: function(data) {
            if (data.row.index === 1) {
                data.cell.styles.fillColor = [200, 220, 240];
            }
        },
    });

    y = doc.autoTable.previous.finalY + 10;
    
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text('Este documento es un comprobante de pago. Guarde para sus registros.', 10, y);
    y += 5;
    doc.text(`*El estado final del pr√©stamo es: ${remainingBalanceAfter > 0.01 ? 'Activo' : 'Pagado'}.`, 10, y);

    y = doc.internal.pageSize.height - 30; 
    doc.line(70, y, 140, y);
    doc.text('Firma/Sello de Presta Bill', pageWidth / 2, y + 5, { align: "center" });

    return { doc, clientName: client.name, cobroDate: cobro.date };
}

function generateInvoicePDF(cobroId, previousState = {}) {
    const result = createInvoiceDocument(cobroId, previousState);
    if (!result) return;
    
    const { doc, clientName, cobroDate } = result;

    const fileName = `Factura_Cobro_${clientName.replace(/\s/g, '_')}_${cobroDate.replace(/\//g, '-')}.pdf`;
    doc.save(fileName);
    showToast(`Factura descargada: ${fileName}`, 'info'); 
}

function viewInvoicePDF(cobroId, previousState = {}) {
    const result = createInvoiceDocument(cobroId, previousState);
    if (!result) return;
    
    const { doc, clientName, cobroDate } = result;

    const pdfDataUri = doc.output('datauristring');
    
    const iframe = document.getElementById('invoice-iframe');
    const modal = document.getElementById('invoice-modal');
    const title = document.getElementById('modal-invoice-title');
    
    iframe.src = pdfDataUri;
    title.textContent = `Factura de Cobro: ${clientName} (${cobroDate})`;
    currentCobroId = cobroId; 
    
    modal.style.display = 'flex';
}

function closeInvoiceModal() {
    const modal = document.getElementById('invoice-modal');
    const iframe = document.getElementById('invoice-iframe');
    modal.style.display = 'none';
    iframe.src = 'about:blank'; 
    currentCobroId = null; 
}

function downloadInvoice() {
    if (currentCobroId) {
        generateInvoicePDF(currentCobroId); 
        closeInvoiceModal(); 
    } else {
        showToast("No hay una factura seleccionada para descargar.", 'error'); 
    }
}


function refreshPendingPayments() {
    const allLoans = DB.get("loans").filter(l => l.status !== 'Pagado');
    const box = document.getElementById("pending-payments-list");

    if (allLoans.length === 0) {
        box.innerHTML = '<p style="text-align:center;">No hay pr√©stamos pendientes de pago.</p>';
        return;
    }

    const tableRows = allLoans.map((l, index) => {
        const risk = calculateLoanRisk(l);
        const totalPagar = Number(l.amount) + Number(l.totalInterest);
        const remainingBalance = totalPagar - Number(l.totalPaidAmount);
        
        const moraClass = risk.monthsBehind > 0 ? 'mora-alert-text' : '';
        const moraText = risk.monthsBehind > 0 ? `${risk.monthsBehind} Meses` : 'Al d√≠a';
        const nextDueText = risk.nextDueDate ? risk.nextDueDate.split('-').reverse().join('/') : 'N/A';
        const dueAmountText = risk.monthsBehind > 0 ? formatCurrency(risk.totalDue) : formatCurrency(l.monthlyPayment);

        return `
            <tr class="${index % 2 === 0 ? 'neutral-row-even' : 'neutral-row-odd'}"
                ondblclick="
                    document.getElementById('payment-loan-id').value='${l.id}'; 
                    updatePaymentDetails();
                    document.getElementById('payment-amount').scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                    document.getElementById('payment-amount').focus();" 
                style="cursor:pointer;">
                <td class="client-loan-cell">${l.clientName}</td>
                <td>${l.paymentsMade}/${l.termMonths}</td>
                <td>${nextDueText}</td>
                <td>${formatCurrency(remainingBalance)}</td>
                <td class="${moraClass}">${moraText}</td>
                <td>${dueAmountText}</td>
                <td>
                    <button class="action-btn" style="padding: 5px 10px; width:auto; font-size:14px; background:#4a6d4a;" 
                        onclick="event.stopPropagation(); 
                        document.getElementById('payment-loan-id').value='${l.id}'; 
                        updatePaymentDetails(); 
                        document.getElementById('payment-amount').scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                        document.getElementById('payment-amount').focus();">Cobrar
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    box.innerHTML = `
        <div class="card">
        <div class="table-responsive-container"> 
                <table>
                    <thead>
                        <tr class="neutral-header">
                            <th>Cliente</th>
                            <th>Cuotas Pagas</th>
                            <th>Pr√≥x. Vencimiento</th>
                            <th>Saldo Total Restante</th>
                            <th>Estatus Mora</th>
                            <th>Monto Adeudado (Hoy)</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${tableRows}
                    </tbody>
                </table>
            </div> 
            <p style="font-size:0.9em; margin-top:15px; color:#666;">*Doble clic en la fila para cargar el pr√©stamo en el formulario de pago.</p>
        </div>
    `;
}

// VISTA: HISTORIAL DE COBROS
function renderCobrosHistory() {
    main.innerHTML = `
        <h2>Historial de Transacciones (Cobros) üìú</h2>
        <div id="cobros-history-list"></div>
    `;
    refreshCobrosHistory();
}

function refreshCobrosHistory() {
    const allCobros = DB.getInitialCobros().sort((a, b) => new Date(b.fullDateTime) - new Date(a.fullDateTime)); 
    const box = document.getElementById("cobros-history-list");

    if (allCobros.length === 0) {
        box.innerHTML = '<p style="text-align:center; padding:20px;">No hay transacciones de cobros registradas.</p>';
        return;
    }

    const tableRows = allCobros.map((c, index) => `
        <tr class="${index % 2 === 0 ? 'neutral-row-even' : 'neutral-row-odd'}">
            <td>${c.date}</td>
            <td>${c.clientName}</td>
            <td>${formatCurrency(c.amount)}</td>
            <td>
                <button class="action-btn" style="padding: 5px 10px; width:auto; font-size:14px; background:#8e44ad; margin-right: 5px;" onclick="viewInvoicePDF('${c.id}')">üëÅÔ∏è Ver Factura</button>
                <button class="action-btn" style="padding: 5px 10px; width:auto; font-size:14px; background:#2ecc71; margin-right: 5px;" onclick="generateInvoicePDF('${c.id}')">‚¨áÔ∏è Descargar</button>
                <button class="action-btn" style="padding: 5px 10px; width:auto; font-size:14px; background:#e74c3c;" onclick="deleteCobro('${c.id}')">üóëÔ∏è Eliminar</button>
            </td>
        </tr>
    `).join('');

    box.innerHTML = `
        <div class="card">
            <table>
                <thead>
                    <tr class="neutral-header">
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Monto Cobrado</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </div>
    `;
}

function deleteCobro(cobroId) {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para editar o eliminar datos.", 'error');
        abrirModal();
        return;
    }
    
    if (!confirm("ADVERTENCIA: ¬øEst√° seguro de que desea eliminar este cobro? Esto ajustar√° los saldos del pr√©stamo asociado.")) return;

    let allCobros = DB.getInitialCobros();
    const cobroIndex = allCobros.findIndex(c => c.id === cobroId);
    if (cobroIndex === -1) return;
    
    const cobroToDelete = allCobros[cobroIndex];
    allCobros.splice(cobroIndex, 1);
    DB.set("cobros", allCobros);
    
    let allLoans = DB.get("loans");
    const loanIndex = allLoans.findIndex(l => l.id === cobroToDelete.loanId);
    
    if (loanIndex !== -1) {
        const loan = allLoans[loanIndex];
        const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
        const cuotaMensual = Number(loan.monthlyPayment);
        
        const newTotalPaidAmount = allCobros
            .filter(c => c.loanId === loan.id)
            .reduce((sum, current) => sum + Number(current.amount), 0);

        loan.totalPaidAmount = newTotalPaidAmount;
        loan.paymentsMade = Math.floor(newTotalPaidAmount / cuotaMensual);

        const newRemaining = totalPagar - loan.totalPaidAmount;
        if (newRemaining > 0.01) { 
            loan.status = 'Activo';
        } else {
             loan.status = 'Pagado'; 
             loan.totalPaidAmount = totalPagar;
             loan.paymentsMade = Number(loan.termMonths);
        }
        
        allLoans[loanIndex] = loan;
        DB.set("loans", allLoans);
    }

    refreshCobrosHistory(); 
    
    if (document.getElementById('pending-payments-list')) {
        refreshPendingPayments();
    }
    
    showToast("Cobro eliminado y saldo de pr√©stamo ajustado correctamente.", 'warning'); 
}

// VISTA: REPORTES
function renderReports() {
    
    const summary = calculateLoanPortfolioSummary();
    
    main.innerHTML = `
        <h2>Reportes y An√°lisis üìä</h2>
        
        <div class="dashboard-cards-container">
            <div class="card card-no-border-left" style="flex:1 1 200px; border-left: 5px solid #1c5d99;">
                <h3>Total Prestado (Principal)</h3>
                <p style="font-size:30px; font-weight:bold;">${formatCurrency(summary.totalPrincipalLent)}</p>
                <p style="margin:0; font-size:0.9em; color:#888;">Capital inicial prestado.</p>
            </div>
            <div class="card card-no-border-left" style="flex:1 1 200px; border-left: 5px solid #e74c3c;">
                <h3>Capital en Mora Adeudado</h3>
                <p style="font-size:30px; font-weight:bold; color:#e74c3c;">${formatCurrency(summary.moraAmount)}</p>
                <p style="margin:0; font-size:0.9em; color:#888;">Monto de cuotas vencidas y no pagadas.</p>
            </div>
        </div>

        <h3>Ranking de Clientes (Por Monto Prestado)</h3>
        <div id="client-ranking-list"></div>

        <h3>Detalle de Pr√©stamos en Mora</h3>
        <div id="mora-loans-detail-container">
            <div id="mora-loans-detail">Cargando...</div>
        </div>
    `;
    
    renderClientRanking();
    renderMoraLoansDetail();
}

function renderClientRanking() {
    const loans = DB.get("loans");
    const clientRanking = {};

    loans.forEach(loan => {
        if (!clientRanking[loan.clientId]) {
            clientRanking[loan.clientId] = {
                name: loan.clientName,
                totalAmount: 0,
                activeLoans: 0
            };
        }
        clientRanking[loan.clientId].totalAmount += Number(loan.amount);
        if (loan.status === 'Activo') {
            clientRanking[loan.clientId].activeLoans += 1;
        }
    });

    let rankingArray = Object.values(clientRanking).sort((a, b) => b.totalAmount - a.totalAmount);

    if (rankingArray.length === 0) {
        document.getElementById('client-ranking-list').innerHTML = '<p style="text-align:center;">No hay datos de pr√©stamos para el ranking.</p>';
        return;
    }

    const tableRows = rankingArray.map((r, index) => `
        <tr class="${index % 2 === 0 ? 'neutral-row-even' : 'neutral-row-odd'}">
            <td>#${index + 1}</td>
            <td class="client-loan-cell">${r.name}</td>
            <td>${formatCurrency(r.totalAmount)}</td>
            <td>${r.activeLoans}</td>
        </tr>
    `).join('');

    document.getElementById('client-ranking-list').innerHTML = `
        <div class="card">
            <table>
                <thead>
                    <tr class="neutral-header">
                        <th>Ranking</th>
                        <th>Cliente</th>
                        <th>Total Prestado (Principal)</th>
                        <th>Pr√©stamos Activos</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </div>
    `;
}

function renderMoraLoansDetail() {
    const allLoans = DB.get("loans");
    const loansInMora = allLoans
        .map(l => ({ ...l, risk: calculateLoanRisk(l) }))
        .filter(l => l.risk.monthsBehind > 0)
        .sort((a, b) => b.risk.monthsBehind - a.risk.monthsBehind); 

    const box = document.getElementById("mora-loans-detail");

    if (loansInMora.length === 0) {
        box.innerHTML = '<p style="text-align:center; padding:20px;">¬°Excelente! No hay pr√©stamos actualmente en mora.</p>';
        return;
    }
    
    const tableRows = loansInMora.map((l, index) => {
        const totalPagar = Number(l.amount) + Number(l.totalInterest);
        const remainingBalance = totalPagar - Number(l.totalPaidAmount);
        
        return `
            <tr class="${index % 2 === 0 ? 'neutral-row-even' : 'neutral-row-odd'}">
                <td class="client-loan-cell">${l.clientName}</td>
                <td class="mora-alert-text">${l.risk.monthsBehind}</td>
                <td>${l.paymentsMade}/${l.termMonths}</td>
                <td>${formatCurrency(remainingBalance)}</td>
                <td>${formatCurrency(l.risk.totalDue)}</td>
            </tr>
        `;
    }).join('');

    box.innerHTML = `
        <table>
            <thead>
                <tr class="neutral-header">
                    <th>Cliente</th>
                    <th>Meses Atraso</th>
                    <th>Cuotas Pagadas</th>
                    <th>Saldo Total Restante</th>
                    <th>Monto en Mora Adeudado (Cuotas)</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
    `;
}

// VISTA: CONFIGURACIONES
function renderSettings() {
    const settings = DB.getSettings();
    main.innerHTML = `
        <h2>Configuraciones Globales ‚öôÔ∏è</h2>
        <div class="card" style="background: #f0f7ff; border: 1px solid #d0e8ff;">
            <h3 style="margin-top:0;">Par√°metros Financieros</h3>
            <label for="setting-currency-symbol" style="display:block; font-weight:bold; margin-bottom:5px;">S√≠mbolo de Moneda (Ej: RD$, US$):</label>
            <input type="text" id="setting-currency-symbol" class="form-input" value="${settings.currencySymbol}" style="margin-bottom:15px;">
            
            <label for="setting-interest-rate" style="display:block; font-weight:bold; margin-bottom:5px;">Tasa de Inter√©s Base (%) - Para 3 meses:</label>
            <input type="number" id="setting-interest-rate" class="form-input" value="${settings.baseInterestRate}" min="0" step="0.1" style="margin-bottom:15px;">
            
            <button class="action-btn" onclick="saveSettings()">üíæ Guardar Configuraciones</button>
        </div>
    `;
}

function saveSettings() {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para guardar configuraciones.", 'error');
        abrirModal();
        return;
    }
    
    const currencySymbol = document.getElementById("setting-currency-symbol").value.trim();
    const baseInterestRate = Number(document.getElementById("setting-interest-rate").value);
    
    if (!currencySymbol || baseInterestRate < 0) {
        showToast("Por favor, ingrese un s√≠mbolo de moneda y una tasa de inter√©s base v√°lida (mayor o igual a cero).", 'error'); 
        return;
    }

    const newSettings = {
        currencySymbol: currencySymbol,
        baseInterestRate: baseInterestRate
    };
    
    DB.set("settings", newSettings);
    showToast("Configuraciones guardadas. Es posible que deba recargar las vistas para ver los cambios de moneda.", 'success'); 
    
    renderSettings(); 
}

// VISTA: MANTENIMIENTO
function renderMaintenance() {
    main.innerHTML = `
        <h2>Mantenimiento y Respaldo üíæ</h2>
        
        <div class="card" style="background: #fff0f0; border: 1px solid #e74c3c;">
            <h3 style="color:#e74c3c;">Restablecer Datos</h3>
            <p>Esta acci√≥n eliminar√° todos los datos de Clientes, Pr√©stamos y Cobros de forma permanente. **¬°No se puede deshacer!**</p>
            <button class="action-btn" style="background:#c0392b;" onclick="resetData()">üóëÔ∏è Eliminar Todos los Datos</button>
        </div>
        
        <div class="card" style="background: #fdf5e6; border: 1px solid #f39c12;">
            <h3 style="color:#f39c12;">Control de Suscripci√≥n (Debugging)</h3>
            <p>Si el bot√≥n de PayPal no aparece, haz clic aqu√≠ para forzar la inactividad de la suscripci√≥n (solo para pruebas/debugging).</p>
            <button class="action-btn" style="background:#f39c12;" onclick="resetSubscriptionState()">üîÑ Resetear Estado de Suscripci√≥n</button>
        </div>
        <div class="card">
            <h3>Exportar Respaldo</h3>
            <p>Guarde un respaldo de todos los datos como un archivo JSON. Puede importarlo m√°s tarde o usarlo como copia de seguridad.</p>
            <button class="action-btn" onclick="exportData()">‚¨áÔ∏è Exportar Datos (JSON)</button>
        </div>
        
        <div class="card">
            <h3>Importar Respaldo</h3>
            <p>Seleccione un archivo JSON de respaldo para restaurar los datos. **Esto sobrescribir√° los datos existentes.**</p>
            <input type="file" id="import-file" accept=".json" class="form-input" style="margin-bottom:10px;">
            <button class="action-btn" onclick="importData()">‚¨ÜÔ∏è Importar Datos (JSON)</button>
        </div>
    `;
}

function resetData() {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para realizar el mantenimiento.", 'error');
        abrirModal();
        return;
    }
    
    if (confirm("¬øEst√° absolutamente seguro? Se eliminar√°n todos los datos (Clientes, Pr√©stamos, Cobros, Configuraciones) de forma permanente.")) {
        localStorage.removeItem("clients");
        localStorage.removeItem("loans");
        localStorage.removeItem("cobros");
        localStorage.removeItem("settings");
        showToast("Todos los datos han sido eliminados. Se reiniciar√° la aplicaci√≥n al Dashboard.", 'warning'); 
        renderDashboard(); 
    }
}

function exportData() {
    const data = {
        clients: DB.get("clients"),
        loans: DB.get("loans"),
        cobros: DB.getInitialCobros(),
        settings: DB.getSettings()
    };
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `PrestaBill_Respaldo_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast("Datos exportados correctamente.", 'success'); 
}

function importData() {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para importar datos.", 'error');
        abrirModal();
        return;
    }
    
    const fileInput = document.getElementById("import-file");
    const file = fileInput.files[0];
    
    if (!file) {
        showToast("Por favor, seleccione un archivo JSON para importar.", 'error'); 
        return;
    }
    
    if (!confirm("ADVERTENCIA: ¬øEst√° seguro? La importaci√≥n sobrescribir√° TODOS los datos actuales con el contenido del archivo.")) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (importedData.clients && importedData.loans && importedData.cobros) {
                DB.set("clients", importedData.clients);
                DB.set("loans", importedData.loans);
                DB.set("cobros", importedData.cobros);
                
                if (importedData.settings) {
                    DB.set("settings", importedData.settings);
                } else {
                     DB.set("settings", DEFAULT_SETTINGS); 
                }
                
                showToast("Datos importados y restaurados correctamente. Se reiniciar√° la aplicaci√≥n al Dashboard.", 'success'); 
                renderDashboard();
            } else {
                showToast("Error: El archivo JSON no tiene la estructura de respaldo esperada (clients, loans, cobros).", 'error'); 
            }
        } catch (error) {
            showToast("Error al procesar el archivo: " + error.message, 'error'); 
        }
    };
    reader.readAsText(file);
}

function resetSubscriptionState() {
    if (!confirm("¬øEst√°s seguro de que quieres forzar la inactividad de la suscripci√≥n de PayPal? Esto har√° que el bot√≥n de pago vuelva a aparecer y reiniciar√° el Dashboard.")) {
        return;
    }

    localStorage.setItem("paypalSubscription", "inactive");
    
    if (document.getElementById("modal-overlay").style.display === "flex") {
        cargarBotonPayPal(); 
    }

    showToast("Estado de Suscripci√≥n reseteado a INACTIVO. Intenta abrir el men√∫ y luego el bot√≥n 'Suscripci√≥n'.", 'warning');
    renderDashboard(); 
}
// ===============================================
// FIN: FUNCIONES DE CLIENTES, PR√âSTAMOS, COBROS, etc.
// ===============================================

// INICIALIZACI√ìN
document.addEventListener("DOMContentLoaded", function() {
    verificarAcceso(); 
    renderDashboard();
});
</script>
</body>
</html>
