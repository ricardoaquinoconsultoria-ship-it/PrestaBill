```javascript
                </div>
                <button class="action-btn" style="padding: 8px 15px; margin-top:10px; background:${color};">Registrar Cobro</button>
            </div>
        `;
    }).join('');

    container.innerHTML = `
        <div class="carousel-container">
            <div id="carousel-slides" class="carousel-slides">
                ${slidesHTML}
            </div>
            <button id="prev-btn" class="carousel-nav-btn" onclick="moveCarousel(-1)">&#10094;</button>
            <button id="next-btn" class="carousel-nav-btn" onclick="moveCarousel(1)">&#10095;</button>
        </div>
    `;
    
    if (window.innerWidth < 768 || upcomingPayments.length <= 3) {
        document.getElementById('prev-btn').style.display = 'none';
        document.getElementById('next-btn').style.display = 'none';
    } else {
        updateCarouselButtons();
    }
}

function moveCarousel(direction) {
    const slides = document.getElementById('carousel-slides');
    const items = slides.getElementsByClassName('carousel-item');
    if (items.length === 0) return;
    
    const maxIndex = items.length - 1; 
    
    carouselIndex = Math.max(0, Math.min(maxIndex, carouselIndex + direction));
    
    const scrollPosition = carouselIndex * items[0].offsetWidth + (carouselIndex * 15); 
    
    slides.scrollTo({
        left: scrollPosition,
        behavior: 'smooth'
    });
    
    updateCarouselButtons();
}

function updateCarouselButtons() {
    const items = document.getElementById('carousel-slides').getElementsByClassName('carousel-item');
    const prevBtn = document.getElementById('prev-btn');
    const nextBtn = document.getElementById('next-btn');
    
    if (!prevBtn || !nextBtn || items.length === 0) return;

    prevBtn.style.visibility = carouselIndex > 0 ? 'visible' : 'hidden';
    nextBtn.style.visibility = (carouselIndex < items.length - 3) ? 'visible' : 'hidden';
}


// ===============================================
// VISTA: DASHBOARD
// ===============================================
function calculateLoanPortfolioSummary() {
    const allLoans = DB.get("loans");
    const allCobros = DB.getInitialCobros();
    let netBalancePending = 0; 
    let moraAmount = 0;
    let totalPrincipalLent = 0;

    for (const loan of allLoans) {
        const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
        totalPrincipalLent += Number(loan.amount);

        const totalPaidAmount = allCobros
            .filter(c => c.loanId === loan.id)
            .reduce((sum, current) => sum + Number(current.amount), 0);
        
        const remainingBalance = totalPagar - totalPaidAmount;
        
        if (remainingBalance > 0.01) { 
            netBalancePending += remainingBalance;
        }

        const risk = calculateLoanRisk(loan);
        if (risk.monthsBehind > 0) {
            moraAmount += risk.totalDue; 
        }
    }

    return { netBalancePending, moraAmount, totalPrincipalLent };
}


function renderDashboard(){
  const clients = DB.get("clients").length;
  const cobros = DB.getInitialCobros(); 
  
  const totalGanancias = cobros.reduce((a,b)=> a+Number(b.amount),0); 

  const summary = calculateLoanPortfolioSummary();
  const netBalancePending = summary.netBalancePending; 
  
  const allLoans = DB.get("loans");
  const loansInMora = allLoans.filter(l => calculateLoanRisk(l).monthsBehind > 0); 
  
  let premiumWarning = '';
  if (!trialActivo() && !suscripcionActiva()) {
    premiumWarning = `
      <div class="card" style="border-left: 5px solid #e74c3c; background: #fff0f0; margin-bottom: 20px;">
        <h3 style="color:#e74c3c; margin-top:0;">‚ö†Ô∏è ¬°Tu Per√≠odo de Prueba ha Expirado!</h3>
        <p>Tu aplicaci√≥n est√° ahora en modo limitado. Por favor, haz clic en el bot√≥n **"Suscripci√≥n"** del men√∫ para desbloquear todas las funciones sin restricciones.</p>
        <button class="action-btn" style="background:#e74c3c;" onclick="abrirModal()">Ir a Suscripci√≥n</button>
      </div>
    `;
  } else if (trialActivo()) {
     premiumWarning = `
      <div class="card" style="border-left: 5px solid #f39c12; background: #fff8e1; margin-bottom: 20px;">
        <h3 style="color:#f39c12; margin-top:0;">‚è≥ Per√≠odo de Prueba Activo</h3>
        <p>Te quedan **${diasRestantesTrial()} d√≠as** de prueba. ¬°Aprovecha! Luego, haz clic en el bot√≥n **"Suscripci√≥n"** del men√∫ para mantener tu acceso sin l√≠mites.</p>
      </div>
    `;
  }


  main.innerHTML = `
    <h2>Resumen de Pr√©stamos üìà</h2>
    
    ${premiumWarning}
    
    <h3>Pr√≥ximas Cuotas a Vencer (60 d√≠as)</h3>
    <div id="upcoming-payments-carousel-container">
    </div>

    <div class="dashboard-cards-container">
        
        <div class="card" style="border-left: 5px solid #2980b9;">
            <h3>Clientes Totales</h3>
            <p style="font-size:36px; font-weight:bold;">${clients}</p>
            <p style="margin:0; font-size:0.9em; color:#888;">Total de personas registradas.</p>
        </div>
        
        <div class="card" style="border-left: 5px solid #2ecc71;">
            <h3>Ganancias Recibidas</h3>
            <p style="font-size:36px; font-weight:bold;">${formatCurrency(totalGanancias)}</p>
            <p style="margin:0; font-size:0.9em; color:#888;">Monto total de cobros hist√≥ricos.</p>
        </div>

        <div class="card" style="border-left: 5px solid #1c5d99;">
            <h3>Potencial de Ingreso</h3>
            <p style="font-size:36px; font-weight:bold;">${formatCurrency(netBalancePending)}</p>
            <p style="margin:0; font-size:0.9em; color:#888;">Total (Ppal + Inter√©s) por cobrar.</p>
        </div>
        
        <div class="card" style="border-left: 5px solid ${loansInMora.length > 0 ? '#e74c3c' : '#2ecc71'};">
            <h3>Pr√©stamos en Mora ‚ö†Ô∏è</h3>
            <p style="font-size:36px; font-weight:bold; color: ${loansInMora.length > 0 ? '#e74c3c' : '#2ecc71'};">
                ${loansInMora.length}
            </p>
            <p style="margin:0; font-size:0.9em; color:#888;">Pr√©stamos con 1+ cuota de atraso.</p>
        </div>
    </div>

    <h3>Distribuci√≥n de Capital Prestado</h3>
    <div class="card">
        <div style="max-height: 400px;"> 
            <canvas id="loanDistributionChart"></canvas>
        </div>
    </div>
  `;
  
  renderUpcomingPaymentsCarousel();
  
  renderLoanDistributionChart();
}

function renderLoanDistributionChart() {
    const loans = DB.get("loans");
    if (loans.length === 0) return;

    const clientAmounts = {};
    loans.forEach(loan => {
        clientAmounts[loan.clientName] = (clientAmounts[loan.clientName] || 0) + Number(loan.amount);
    });

    const labels = Object.keys(clientAmounts);
    const data = Object.values(clientAmounts);
    
    const getColors = (count) => {
        const colors = [
            '#1c5d99', '#4a6d4a', '#f39c12', '#e74c3c', '#9b59b6', 
            '#34495e', '#1abc9c', '#f1c40f', '#2980b9', '#c0392b'
        ];
        return Array.from({length: count}, (_, i) => colors[i % colors.length]);
    };

    new Chart(document.getElementById('loanDistributionChart'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monto Prestado',
                data: data,
                backgroundColor: getColors(labels.length),
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, 
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Monto Principal Prestado por Cliente'
                }
            }
        }
    });
}

// ===============================================
// FUNCIONES DE CLIENTES
// ===============================================

function calculateTotalLoanAmount(clientId) {
    const loans = DB.get("loans");
    return loans
        .filter(l => l.clientId === clientId)
        .reduce((sum, current) => sum + Number(current.amount), 0);
}


function renderClients(){
  main.innerHTML = `
    <h2>Clientes üë•</h2>
    <div style="margin-bottom:20px;">
        <input id="client-search" placeholder="Buscar por Nombre o C√©dula..." class="form-input" onkeyup="refreshClientsList(this.value)">
    </div>
    
    <div class="card" style="background: #f0f7ff; border: 1px solid #d0e8ff;">
        <h3 style="margin-top:0;">Agregar Nuevo Cliente</h3>
        <div style="display:grid; gap:10px;">
            <input id="client-name" placeholder="Nombre (Requerido)" class="form-input">
            <input type="number" id="client-cedula" placeholder="C√©dula/ID (Requerido)" class="form-input">
            <input id="client-address" placeholder="Direcci√≥n Residencial" class="form-input">
            <input type="tel" id="client-phone-main" placeholder="Tel√©fono Principal" class="form-input"> 
            <input type="tel" id="client-phone-mobile" placeholder="Celular" class="form-input">
            <button class="action-btn" onclick="addClient()">Agregar Cliente</button>
        </div>
    </div>
    
    <div id="no-clients-warning" style="display:none; text-align:center; padding:20px; border-radius:10px; background:#fff3cd; border:1px solid #ffeeba; color:#856404; margin-bottom:20px;">
        ‚ö†Ô∏è **No hay clientes registrados.** Por favor, a√±ada uno usando el formulario de arriba.
    </div>

    <div id="clients-list"></div>
  `;
  refreshClientsList();
}

function addClient(){
  if (!trialActivo() && !suscripcionActiva()) {
    showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para agregar nuevos clientes.", 'error');
    abrirModal(); 
    return;
  }
  
  const name = document.getElementById("client-name").value.trim();
  const cedula = document.getElementById("client-cedula").value.trim();
  const address = document.getElementById("client-address").value.trim();
  const phoneMain = document.getElementById("client-phone-main").value.trim();
  const phoneMobile = document.getElementById("client-phone-mobile").value.trim();
  
  if(!name || !cedula) {
    showToast("Nombre y C√©dula/ID son requeridos", 'error'); 
    return;
  }
  
  const all = DB.get("clients");
  
  const isDuplicate = all.some(client => client.cedula === cedula);
  if (isDuplicate) {
    showToast(`Error: Ya existe un cliente con la C√©dula/ID ${cedula}.`, 'error');
    return;
  }

  all.push({
    id: genId(), 
    name, 
    cedula,             
    address,            
    phoneMain,          
    phoneMobile         
  });
  DB.set("clients", all);
  
  document.getElementById("client-name").value = '';
  document.getElementById("client-cedula").value = '';
  document.getElementById("client-address").value = '';
  document.getElementById("client-phone-main").value = '';
  document.getElementById("client-phone-mobile").value = '';
  
  refreshClientsList();
  showToast("Cliente agregado correctamente", 'success'); 
}

function refreshClientsList(searchTerm = ''){
  let list = DB.get("clients");
  const box = document.getElementById("clients-list");
  const warningBox = document.getElementById("no-clients-warning");
  
  if(searchTerm.trim()){
    const term = searchTerm.toLowerCase().trim();
    list = list.filter(c => 
      c.name.toLowerCase().includes(term) || 
      c.cedula.toLowerCase().includes(term)
    );
  }

  if(list.length===0){ 
    box.innerHTML=`<p style="text-align:center; padding:20px;">${searchTerm ? 'No se encontraron clientes que coincidan con la b√∫squeda.' : ''}</p>`; 
    if (!searchTerm && warningBox) {
        warningBox.style.display = 'block'; 
    } else if (warningBox) {
        warningBox.style.display = 'none';
    }
    return; 
  } else if (warningBox) {
      warningBox.style.display = 'none';
  }
  
  box.innerHTML = list.map(c=>{
    const totalPrestado = calculateTotalLoanAmount(c.id);

    return `
      <div class="card" id="client-card-${c.id}">
          <div id="client-view-${c.id}">
              <h4 style="margin:0 0 5px 0; color:#1c5d99;">${c.name}</h4>
              C√©dula: ${c.cedula || 'N/A'}<br>
              Dir: ${c.address || 'N/A'}<br>
              Total Capital Prestado: <b style="color:#2ecc71;">${formatCurrency(totalPrestado)}</b><br>
              Tel: ${c.phoneMain || 'N/A'} / Cel: ${c.phoneMobile || 'N/A'}<br><br>
              
              <div style="display:flex; gap:10px;">
                  <button class="action-btn" style="flex:1; background:#f39c12;" onclick="prepareEdit('${c.id}')">‚úèÔ∏è Editar</button>
                  <button class="action-btn" style="flex:1; background:#e74c3c;" onclick="deleteClient('${c.id}')">üóëÔ∏è Eliminar</button>
              </div>
          </div>
          <div id="client-edit-${c.id}" style="display:none;">
          </div>
      </div>
    `;
  }).join("");
}

function deleteClient(id) {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para editar o eliminar datos.", 'error');
        abrirModal();
        return;
    }
    
    if (!confirm("ADVERTENCIA: ¬øEst√° seguro de que desea eliminar a este cliente? Esto eliminar√° PERMANENTEMENTE todos sus pr√©stamos y el historial de cobros asociados.")) return;

    let allClients = DB.get("clients");
    allClients = allClients.filter(c => c.id !== id);
    DB.set("clients", allClients);
    
    let allLoans = DB.get("loans");
    const loansToDelete = allLoans.filter(l => l.clientId === id); 
    allLoans = allLoans.filter(l => l.clientId !== id);
    DB.set("loans", allLoans);

    let allCobros = DB.getInitialCobros();
    const loanIdsToDelete = loansToDelete.map(l => l.id);
    
    allCobros = allCobros.filter(c => !loanIdsToDelete.includes(c.loanId));
    DB.set("cobros", allCobros);

    const searchTerm = document.getElementById("client-search") ? document.getElementById("client-search").value : '';
    refreshClientsList(searchTerm);
    
    showToast("Cliente, pr√©stamos y cobros asociados eliminados correctamente.", 'warning');
}


function prepareEdit(id) {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para editar datos.", 'error');
        abrirModal();
        return;
    }
    
    const client = DB.get("clients").find(c => c.id === id);
    if (!client) return;

    const totalPrestado = calculateTotalLoanAmount(id);

    document.getElementById(`client-view-${id}`).style.display = 'none';
    const editBox = document.getElementById(`client-edit-${id}`);
    editBox.style.display = 'block';

    editBox.innerHTML = `
        <input id="edit-name-${id}" value="${client.name}" placeholder="Nombre" class="form-input" style="margin-bottom:5px;">
        <input type="number" id="edit-cedula-${id}" value="${client.cedula}" placeholder="C√©dula" class="form-input" style="margin-bottom:5px;">
        <input id="edit-address-${id}" value="${client.address || ''}" placeholder="Direcci√≥n Residencial" class="form-input" style="margin-bottom:5px;">
        <input type="tel" id="edit-phone-main-${id}" value="${client.phoneMain || ''}" placeholder="Tel√©fono Principal" class="form-input" style="margin-bottom:5px;">
        <input type="tel" id="edit-phone-mobile-${id}" value="${client.phoneMobile || ''}" placeholder="Celular" class="form-input" style="margin-bottom:10px;">
        
        <p style="margin: 0 0 10px 0; padding:10px; background:#f0f0f0; border-radius:5px;">
            **Capital Total Prestado:** <span style="font-weight:bold; color:#1c5d99;">${formatCurrency(totalPrestado)}</span> 
            (No editable aqu√≠. Se gestiona en "Pr√©stamos")
        </p>

        <div style="display:flex; gap:10px;">
            <button class="action-btn" style="flex:1; background:#2ecc71;" onclick="saveClient('${id}')">üíæ Guardar Cambios</button>
            <button class="action-btn" style="flex:1; background:#95a5a6;" onclick="cancelEdit('${id}')">‚ùå Cancelar</button>
        </div>
    `;
}

function cancelEdit(id) {
    document.getElementById(`client-view-${id}`).style.display = 'block';
    document.getElementById(`client-edit-${id}`).style.display = 'none';
    document.getElementById(`client-edit-${id}`).innerHTML = ''; 
}

function saveClient(id) {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para editar datos.", 'error');
        abrirModal();
        return;
    }
    
    const name = document.getElementById(`edit-name-${id}`).value.trim();
    const cedula = document.getElementById(`edit-cedula-${id}`).value.trim();
    const address = document.getElementById(`edit-address-${id}`).value.trim();
    const phoneMain = document.getElementById(`edit-phone-main-${id}`).value.trim();
    const phoneMobile = document.getElementById(`edit-phone-mobile-${id}`).value.trim();

    if(!name || !cedula) {
        showToast("Nombre y C√©dula son requeridos para guardar.", 'error'); 
        return;
    }

    let all = DB.get("clients");
    const index = all.findIndex(c => c.id === id);
    if (index === -1) return;
    
    const isDuplicate = all.some(c => c.cedula === cedula && c.id !== id);
    if (isDuplicate) {
        showToast(`Error: Ya existe otro cliente con la C√©dula/ID ${cedula}.`, 'error');
        return;
    }


    all[index] = {
        id: id, 
        name, 
        cedula,             
        address,            
        phoneMain,          
        phoneMobile
    };

    DB.set("clients", all);
    
    const searchTerm = document.getElementById("client-search") ? document.getElementById("client-search").value : '';
    refreshClientsList(searchTerm);
    showToast("Cliente guardado correctamente.", 'success'); 
}

// ===============================================
// VISTA: PR√âSTAMOS
// ===============================================
function renderLoans() {
    const settings = DB.getSettings();
  main.innerHTML = `
    <h2>Pr√©stamos üíµ</h2>
    
    <div class="card" style="text-align:left; background: #f0f7ff; border: 1px solid #d0e8ff;">
        <h3>Registrar Nuevo Pr√©stamo (Cuotas Fijas)</h3>
        
        <label for="loan-client" style="display:block; font-weight:bold; margin-bottom:5px;">Cliente:</label>
        <select id="loan-client" class="form-input" style="margin-bottom:15px;">
            <option value="">-- Seleccione un Cliente --</option>
        </select>
        
        <label for="loan-amount" style="display:block; font-weight:bold; margin-bottom:5px;">Monto del pr√©stamo (${settings.currencySymbol}):</label>
        <input type="number" id="loan-amount" placeholder="Monto Principal (${settings.currencySymbol})" class="form-input" value="10000" min="1" style="margin-bottom:15px;">
        
        <label for="loan-interest-base" style="display:block; font-weight:bold; margin-bottom:5px;">Porcentaje de inter√©s base (%) - Para 3 meses:</label>
        <input type="number" id="loan-interest-base" placeholder="Tasa Base (%)" class="form-input" value="${settings.baseInterestRate}" min="0" step="0.1" style="margin-bottom:15px;">
        
        <label for="loan-term" style="display:block; font-weight:bold; margin-bottom:5px;">Plazo (meses):</label>
        <input type="number" id="loan-term" placeholder="Plazo (Meses)" class="form-input" value="3" min="1" style="margin-bottom:15px;">
        
        <button class="action-btn" onclick="calculateAndSaveLoan()">‚ûï Calcular y Registrar Pr√©stamo</button>
        
        <div id="calculator-summary" style="margin-top: 15px; padding: 15px; border-radius: 8px; background: #fff; border: 1px dashed #ccc;"></div>
    </div>
    
    <div style="margin-top:20px;">
        <h3>Pr√©stamos Activos y Pagados</h3>
        <div id="loans-list">
        </div>
    </div>
  `;
  populateClientSelect(); 
  refreshLoanList();      
}

function populateClientSelect() {
    const clients = DB.get("clients");
    const select = document.getElementById("loan-client");

    if (clients.length === 0) {
        select.innerHTML = '<option value="" disabled>No hay clientes para prestar</option>';
        return;
    }

    select.innerHTML = '<option value="">-- Seleccione un Cliente --</option>'; 
    
    clients.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.name} (C√©dula: ${c.cedula})`;
        select.appendChild(option);
    });
}

function calculateAndSaveLoan() {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para registrar nuevos pr√©stamos.", 'error');
        abrirModal();
        return;
    }
    
    const clientId = document.getElementById("loan-client").value;
    const P = Number(document.getElementById("loan-amount").value); 
    const interesBase = Number(document.getElementById("loan-interest-base").value); 
    const n = Number(document.getElementById("loan-term").value); 
    
    if (!clientId) {
        showToast("Por favor, seleccione un cliente.", 'error'); 
        return;
    }
    if (P <= 0 || interesBase < 0 || n <= 0) {
        showToast("Por favor, complete todos los campos de la calculadora correctamente con valores positivos.", 'error'); 
        return;
    }

    const client = DB.get("clients").find(c => c.id === clientId);
    if (!client) {
        showToast("Cliente no encontrado.", 'error'); 
        return;
    }

    const totalInteres = P * (interesBase / 100) * (n / 3);
    const totalPagar = P + totalInteres;
    const cuotaMensual = totalPagar / n;

    let resultadoHTML = `
        <h4 style="margin-top:0;">Resumen del Pr√©stamo</h4>
        <p style="border-top: 1px solid #ccc; padding-top: 10px;">
            <strong>Monto Pr√©stamo:</strong> ${formatCurrency(P)}<br>
            <strong>Inter√©s Total:</strong> ${formatCurrency(totalInteres)}<br>
            <strong>Total a Pagar:</strong> ${formatCurrency(totalPagar)}<br>
            <strong style="color:#1c5d99; font-size: 1.2em;">Cuota Mensual Fija: ${formatCurrency(cuotaMensual)}</strong>
        </p>
    `;
    document.getElementById('calculator-summary').innerHTML = resultadoHTML;
    
    const newLoan = {
        id: genId(),
        clientId: clientId,
        clientName: client.name,
        amount: P.toFixed(2), 
        interestRateBase: interesBase,
        termMonths: n,
        monthlyPayment: cuotaMensual.toFixed(2),
        totalInterest: totalInteres.toFixed(2),
        date: new Date().toLocaleDateString(),
        status: 'Activo',
        paymentsMade: 0, 
        totalPaidAmount: 0, 
        startDate: new Date().toISOString().split('T')[0] 
    };

    const allLoans = DB.get("loans");
    allLoans.push(newLoan);
    DB.set("loans", allLoans);

    showToast(`Pr√©stamo registrado. Cuota Mensual: ${formatCurrency(newLoan.monthlyPayment)}`, 'success'); 
    
    const settings = DB.getSettings();
    document.getElementById("loan-amount").value = '10000';
    document.getElementById("loan-interest-base").value = settings.baseInterestRate;
    document.getElementById("loan-term").value = '3';
    document.getElementById("loan-client").value = '';
    document.getElementById('calculator-summary').innerHTML = ''; 

    refreshLoanList(); 
}

function deleteLoan(id) {
    if (!trialActivo() && !suscripcionActiva()) {
        showToast("Funci√≥n Premium: Tu per√≠odo de prueba ha expirado. Suscr√≠bete para editar o eliminar datos.", 'error');
        abrirModal();
        return;
    }
    
    if (!confirm("ADVERTENCIA: ¬øEst√° seguro de que desea eliminar este PR√âSTAMO? Esto eliminar√° PERMANENTEMENTE este pr√©stamo y todos los cobros asociados a √©l.")) return;

    let allLoans = DB.get("loans");
    allLoans = allLoans.filter(l => l.id !== id);
    DB.set("loans", allLoans);
    
    let allCobros = DB.getInitialCobros();
    allCobros = allCobros.filter(c => c.loanId !== id);
    DB.set("cobros", allCobros);

    refreshLoanList(); 
    
    if (document.getElementById('pending-payments-list')) {
        refreshPendingPayments();
    }

    showToast("Pr√©stamo y sus cobros asociados eliminados correctamente.", 'warning'); 
}


function refreshLoanList() {
    const loans = DB.get("loans");
    const box = document.getElementById("loans-list");
    
    if (loans.length === 0) {
        box.innerHTML = '<p style="text-align:center;">No hay pr√©stamos activos registrados.</p>';
        return;
    }

    const tableRows = loans.map(l => {
        const totalPagar = Number(l.amount) + Number(l.totalInterest);
        const paidPercentage = (l.totalPaidAmount / totalPagar) * 100;
        const risk = calculateLoanRisk(l);
        const statusColor = risk.monthsBehind > 0 ? '#e74c3c' : (l.status === 'Pagado' ? '#2ecc71' : '#f39c12');
        const statusText = risk.monthsBehind > 0 ? `Mora (${risk.monthsBehind} meses)` : l.status;
        const progressStyle = paidPercentage > 100 ? 100 : paidPercentage;
        
        let nextDueText = 'N/A';
        if (l.status === 'Pagado') {
            nextDueText