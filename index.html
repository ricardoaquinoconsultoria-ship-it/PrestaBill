<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Presta Bill - Dashboard</title>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>

<style>
/* 1. Resetear el Box Sizing para mejor consistencia */
*, *::before, *::after {
  box-sizing: border-box; 
}

body { 
  margin:0; 
  /* MEJORA 1: Tipograf√≠a y color de fondo m√°s suaves */
  font-family: 'Roboto', sans-serif; 
  background:#f9f9f9; /* Fondo m√°s claro */
  color: #333;
}

/* HEADER - FIJO AL 100% */
header { 
  background:#1c5d99; /* Color m√°s profesional (Azul Oscuro) */
  color:white; 
  padding:15px; 
  font-size:24px; 
  font-weight: 700;
  display:flex; 
  align-items:center; 
  z-index:1000; 
  position:fixed; 
  top:0; 
  width:100%; 
  left: 0;
  /* MEJORA 2: Sombra en el Header */
  box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

#menu-toggle { 
  cursor:pointer; 
  margin-right:15px; 
  font-size:28px; 
  transition: opacity 0.2s;
}
#menu-toggle:hover { opacity: 0.8; }

/* SIDEBAR */
aside {
  width:260px;
  background:#2c3e50; /* Color Sidebar (Gris Oscuro) */
  color:white;
  padding:10px 0; /* Padding ajustado */
  position:fixed;
  top:0; 
  left:-260px; 
  height:100vh; 
  transition: left 0.3s ease;
  z-index:1001; 
  box-sizing: border-box;
  overflow-y: auto; 
  /* MEJORA 3: Sombra para el Sidebar abierto */
  box-shadow: 2px 0 5px rgba(0, 0, 0, 0.2);
}
aside.open { left:0; }

/* NAV BUTTONS */
.nav-btn { 
  width:calc(100% - 20px); 
  background:transparent; 
  padding:12px 15px; /* M√°s padding */
  border:none; 
  color:white; 
  margin:5px 10px; 
  cursor:pointer; 
  text-align:left; 
  border-radius:6px; 
  font-size:16px; 
  transition: background 0.3s;
  font-weight: 400;
}
.nav-btn:hover { 
  background:#34495e; /* Hover m√°s claro */
} 
/* MEJORA 4: Estilo para el bot√≥n activo (opcional) */
/* .nav-btn.active { background:#1c5d99; } */

/* MAIN */
main {
  padding: 90px 20px 20px 20px; /* Ajuste para header de 60px */
  margin-left: 0; 
  transition: margin-left 0.3s ease;
  width: auto; 
}

/* TARJETAS - Se agrega sombra moderna */
.card { 
  background:white; 
  padding:20px; /* M√°s padding */
  border-radius:10px; 
  margin-bottom:20px; 
  min-height: 100px;
  border: 1px solid #e0e0e0; /* Borde m√°s suave */
  /* MEJORA 5: Sombra suave */
  box-shadow: 0 4px 8px rgba(0, 0, 0, 0.05); 
  /* MEJORA 8: Transici√≥n para feedback visual de tarjeta */
  transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out; 
}
/* MEJORA 8: Efecto de hover */
.card:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
}


/* DASHBOARD CARDS CONTAINER (para la distribuci√≥n) */
.dashboard-cards-container {
    display:flex; 
    gap:20px; 
    flex-wrap:wrap; 
    margin-bottom:20px;
}
.dashboard-cards-container .card {
    flex: 1 1 200px;
    margin-bottom: 0; 
}

/* CONTENEDOR DE CLIENTES Y PRESTAMOS */
#clients-list, #loans-list {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Min-width un poco m√°s grande */
  gap: 20px; 
}

/* NUEVOS ESTILOS PARA FORMULARIO */
.form-input {
  width: 100%; 
  padding: 12px; /* M√°s padding */
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 16px;
  transition: border-color 0.3s, box-shadow 0.3s;
}
/* MEJORA 6: Input Focus State */
.form-input:focus {
    border-color: #1c5d99;
    outline: none;
    box-shadow: 0 0 5px rgba(28, 93, 153, 0.4);
}

/* BOTONES DE ACCI√ìN */
.action-btn {
  background:#1c5d99; 
  color:white; 
  padding:12px; 
  border:none; 
  border-radius:6px; 
  cursor:pointer;
  width: 100%; 
  font-size: 16px;
  font-weight: bold;
  transition: background 0.3s, transform 0.1s;
}
.action-btn:hover { 
    background:#174a7a; 
}
.action-btn:active {
    transform: scale(0.98);
}

/* Ajustes para tablas */
table {
    width: 100%;
    border-collapse: collapse;
}

table td, table th {
    padding: 12px 10px; /* M√°s padding */
    border: none; /* Quitamos el borde de celdas para usar solo el de fila */
    text-align: left;
}

table th {
    background: #e6e6e6; 
    font-weight: 700;
    color: #333;
}

/* MEJORA 7: Estilo Zebra Striping para Tablas */
.neutral-row-even {
    background: #fff !important; 
}
.neutral-row-odd {
    background: #f0f4f7 !important; /* Color muy suave */
}
/* Las filas impares tienen un color suave */

/* MEJORA 10: Cursor Pointer para Feedback UX */
table tr:not(.neutral-header) {
    cursor: pointer;
}
table tr:not(.neutral-header):hover {
    background: #e9eff5 !important;
}


/* Estilo espec√≠fico para la columna con el texto m√°s propenso a desbordarse */
.client-loan-cell {
    max-width: 250px; 
    white-space: normal; 
    word-break: break-word; 
    overflow-wrap: break-word; 
}

/* === ESTILOS DE REPORTES/MORA === */
.neutral-header {
    background: #1c5d99 !important; 
    color: white !important; 
    font-weight: bold;
}

.mora-alert-text {
    font-weight: bold;
    color: #e74c3c; 
}

/* Quitar bordes de color de las tarjetas en reportes */
.card-no-border-left {
    border-left: 1px solid #e0e0e0 !important; 
}

/* Contenedor del detalle de pr√©stamos en mora - Darle borde y fondo neutro */
#mora-loans-detail-container {
    border: 1px solid #e0e0e0;
    background: white;
    padding: 15px;
    border-radius: 10px;
    margin-top: 20px;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
}

/* MEJORA 14: MODAL DE VISUALIZACI√ìN DE FACTURA */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 2000;
    backdrop-filter: blur(5px); /* Fondo desenfocado para destacar el modal */
}
.modal-content {
    background: white;
    padding: 20px; /* M√°s padding */
    border-radius: 8px;
    max-width: 800px; /* Ancho m√°ximo para el PDF */
    width: 90%;
    max-height: 90%;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
}
.modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-bottom: 10px;
    border-bottom: 1px solid #ccc;
    margin-bottom: 10px;
}
.modal-header h3 {
    margin: 0;
    color: #1c5d99;
}
.modal-close-btn {
    background: #e74c3c;
    color: white;
    border: none;
    border-radius: 5px;
    padding: 8px 15px; /* M√°s padding */
    cursor: pointer;
    font-weight: bold;
    transition: background 0.2s;
}
.modal-close-btn:hover {
    background: #c0392b;
}
#invoice-iframe {
    width: 100%;
    flex-grow: 1;
    min-height: 500px; /* Altura m√≠nima para asegurar visibilidad */
    border: 1px solid #ddd;
    border-radius: 4px;
}
.modal-download-btn {
    margin-top: 15px; /* M√°s margen */
    background: #2ecc71;
}

/* === MEJORA 15: ESTILOS DE TOAST/SNACKBAR === */
#snackbar {
    visibility: hidden; /* Oculto por defecto. Lo mostramos con JS. */
    min-width: 250px;
    margin-left: -125px;
    background-color: #333;
    color: #fff;
    text-align: center;
    border-radius: 6px;
    padding: 16px;
    position: fixed;
    z-index: 3000; /* Aseguramos que est√© sobre todos los elementos */
    left: 50%;
    bottom: 30px; 
    box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2);
    font-weight: bold;
}

#snackbar.show {
    visibility: visible;
    -webkit-animation: fadein 0.5s, fadeout 0.5s 2.5s;
    animation: fadein 0.5s, fadeout 0.5s 2.5s;
}

/* Estilos de colores espec√≠ficos para tipos de mensaje */
#snackbar.success { background-color: #2ecc71; }
#snackbar.error { background-color: #e74c3c; }
#snackbar.warning { background-color: #f39c12; }
#snackbar.info { background-color: #1c5d99; }

/* Animaciones */
@-webkit-keyframes fadein {
    from {bottom: 0; opacity: 0;} 
    to {bottom: 30px; opacity: 1;}
}

@keyframes fadein {
    from {bottom: 0; opacity: 0;}
    to {bottom: 30px; opacity: 1;}
}

@-webkit-keyframes fadeout {
    from {bottom: 30px; opacity: 1;} 
    to {bottom: 0; opacity: 0;}
}

@keyframes fadeout {
    from {bottom: 30px; opacity: 1;}
    to {bottom: 0; opacity: 0;}
}
/* === FIN MEJORA 15 === */


/* === FIN DE ESTILOS DE REPORTES/MORA === */

/* MEJORA RESPONSIVE: PARA VISTAS GRANDES (desktop), mantener el layout shifted */
@media (min-width: 768px) {
    main.shifted { 
        /* En desktop, aplicar el margen cuando el men√∫ est√° abierto */
        margin-left: 260px; 
    }
}
</style>
</head>
<body>

<header id="app-header">
  <span id="menu-toggle" 
        role="button" 
        aria-controls="sidebar" 
        /* MEJORA 11: Accesibilidad - ARIA */
        aria-expanded="false" 
        tabindex="0">‚ò∞</span>
  Presta Bill
</header>

<aside id="sidebar">
    <h3 style="padding:15px; margin:0; text-align:center; color:#fff; border-bottom:1px solid #34495e;">Men√∫ Principal</h3>
  <button class="nav-btn" type="button" onclick="renderDashboard(); closeSidebar();">üè† Inicio</button>
  <button class="nav-btn" type="button" onclick="renderClients(); closeSidebar();">üë• Clientes</button>
  <button class="nav-btn" type="button" onclick="renderLoans(); closeSidebar();">üíµ Pr√©stamos</button>
  <button class="nav-btn" type="button" onclick="renderCobros(); closeSidebar();">üí∞ Cobros</button>
  <button class="nav-btn" type="button" onclick="renderReports(); closeSidebar();">üìä Reportes</button>
  <button class="nav-btn" type="button" onclick="renderCobrosHistory(); closeSidebar();">üìú Historial Transacciones</button>
  <button class="nav-btn" type="button" onclick="renderSettings(); closeSidebar();">‚öôÔ∏è Configuraciones</button>
  <button class="nav-btn" type="button" onclick="renderMaintenance(); closeSidebar();">üíæ Mantenimiento</button> 
</aside>

<main id="main"></main>

<div id="invoice-modal" class="modal-overlay" onclick="if(event.target.id === 'invoice-modal') closeInvoiceModal()">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modal-invoice-title">Factura de Cobro</h3>
            <button class="modal-close-btn" onclick="closeInvoiceModal()">X Cerrar</button>
        </div>
        <iframe id="invoice-iframe" title="Visualizaci√≥n de Factura PDF"></iframe>
        
        <button id="modal-download-btn" class="action-btn modal-download-btn" onclick="downloadInvoice()">‚¨áÔ∏è Descargar PDF</button>
    </div>
</div>

<div id="snackbar"></div>

<script>
// ===============================================
// L√ìGICA GENERAL Y DB
// ===============================================
const DEFAULT_SETTINGS = {
    baseInterestRate: 20, // % para 3 meses
    currencySymbol: 'RD$' 
};

// Activar jsPDF en el scope
const { jsPDF } = window.jspdf;

const DB = { 
  get: k => JSON.parse(localStorage.getItem(k)||"[]"), 
  set: (k,v) => localStorage.setItem(k, JSON.stringify(v)),
  
  // *** FUNCI√ìN: Obtener y Inicializar Configuraciones ***
  getSettings: () => {
    let settings = localStorage.getItem("settings");
    if (!settings) {
        DB.set("settings", DEFAULT_SETTINGS);
        return DEFAULT_SETTINGS;
    }
    // Asegurar que existan todos los campos por si se actualiza la app
    return {...DEFAULT_SETTINGS, ...JSON.parse(settings)};
  },
  
  // Inicializaci√≥n simple para evitar errores si no hay datos de cobros
  getInitialCobros: () => {
      let cobros = localStorage.getItem("cobros");
      if (!cobros) {
          DB.set("cobros", []);
          return [];
      }
      return JSON.parse(cobros);
  }
};
const genId = () => "id"+Math.random().toString(36).substr(2,9);

const sidebar = document.getElementById("sidebar");
const main = document.getElementById("main");
const header = document.getElementById("app-header");
const menuToggle = document.getElementById("menu-toggle");
const snackbar = document.getElementById("snackbar"); // MEJORA 15

// MEJORA 15: Funci√≥n para mostrar el Toast/Snackbar
function showToast(message, type = 'info') {
    snackbar.textContent = message;
    snackbar.className = "show " + type;
    setTimeout(function(){ 
        snackbar.className = snackbar.className.replace("show", ""); 
    }, 3000);
}

// MEJORA 9: Funci√≥n de formato de moneda centralizada
function formatCurrency(amount) {
    const settings = DB.getSettings();
    // Usar toFixed(2) para asegurar dos decimales y devolver el string con el s√≠mbolo.
    return `${settings.currencySymbol} ${Number(amount).toFixed(2)}`;
}


// ===============================================
// L√ìGICA DE INTERFAZ (AJUSTADA)
// ===============================================
menuToggle.onclick = () => {
  const isOpening = !sidebar.classList.contains("open");
  
  sidebar.classList.toggle("open");
  
  // MEJORA 11: Actualizar atributos ARIA
  menuToggle.setAttribute('aria-expanded', isOpening.toString());

  if (window.innerWidth >= 768) {
     main.classList.toggle("shifted");
  } else {
     main.classList.remove("shifted"); 
  }
  
  // MEJORA 14: Enfocar el primer bot√≥n del sidebar al abrir
  if (isOpening) {
      const firstNavBtn = sidebar.querySelector('.nav-btn');
      if (firstNavBtn) {
          firstNavBtn.focus();
      }
  }
};

function closeSidebar() {
  if (sidebar.classList.contains("open")) {
    sidebar.classList.remove("open");
    menuToggle.setAttribute('aria-expanded', 'false'); // MEJORA 11
    
    if (window.innerWidth >= 768) {
        main.classList.remove("shifted"); 
    }
  }
}

// ===============================================
// VISTA: DASHBOARD
// ===============================================
function calculateLoanPortfolioSummary() {
    const allLoans = DB.get("loans");
    const allCobros = DB.getInitialCobros();
    let netBalancePending = 0; // Principal + Inter√©s
    let moraAmount = 0;
    let totalPrincipalLent = 0;

    for (const loan of allLoans) {
        // 1. Calcular el total a pagar (Principal + Inter√©s)
        const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
        totalPrincipalLent += Number(loan.amount);

        // 2. Monto pagado hasta la fecha
        const totalPaidAmount = allCobros
            .filter(c => c.loanId === loan.id)
            .reduce((sum, current) => sum + Number(current.amount), 0);
        
        // 3. Saldo pendiente
        const remainingBalance = totalPagar - totalPaidAmount;
        
        if (remainingBalance > 0.01) { // Peque√±o margen
            netBalancePending += remainingBalance;
        }

        // 4. Calcular Mora
        const risk = calculateLoanRisk(loan);
        if (risk.monthsBehind > 0) {
            // Usamos el total adeudado por cuotas vencidas y no pagadas
            moraAmount += risk.totalDue; 
        }
    }

    return { netBalancePending, moraAmount, totalPrincipalLent };
}


function renderDashboard(){
  const clients = DB.get("clients").length;
  const cobros = DB.getInitialCobros(); 
  
  // 1. C√ÅLCULO DE GANANCIAS
  const totalGanancias = cobros.reduce((a,b)=> a+Number(b.amount),0); 

  // 2. C√ÅLCULO DE SALDO PENDIENTE NETO Y MORA 
  const summary = calculateLoanPortfolioSummary();
  const netBalancePending = summary.netBalancePending; 
  
  const allLoans = DB.get("loans");
  const loansInMora = allLoans.filter(l => calculateLoanRisk(l).monthsBehind > 0); 

  main.innerHTML = `
    <h2>Resumen de Pr√©stamos üìà</h2>
    <div class="dashboard-cards-container">
        
        <div class="card" style="border-left: 5px solid #2980b9;">
            <h3>Clientes Totales</h3>
            <p style="font-size:36px; font-weight:bold;">${clients}</p>
            <p style="margin:0; font-size:0.9em; color:#888;">Total de personas registradas.</p>
        </div>
        
        <div class="card" style="border-left: 5px solid #2ecc71;">
            <h3>Ganancias Recibidas</h3>
            <p style="font-size:36px; font-weight:bold;">${formatCurrency(totalGanancias)}</p>
            <p style="margin:0; font-size:0.9em; color:#888;">Monto total de cobros hist√≥ricos.</p>
        </div>

        <div class="card" style="border-left: 5px solid #1c5d99;">
            <h3>Potencial de Ingreso</h3>
            <p style="font-size:36px; font-weight:bold;">${formatCurrency(netBalancePending)}</p>
            <p style="margin:0; font-size:0.9em; color:#888;">Total (Ppal + Inter√©s) por cobrar.</p>
        </div>
        
        <div class="card" style="border-left: 5px solid ${loansInMora.length > 0 ? '#e74c3c' : '#2ecc71'};">
            <h3>Pr√©stamos en Mora ‚ö†Ô∏è</h3>
            <p style="font-size:36px; font-weight:bold; color: ${loansInMora.length > 0 ? '#e74c3c' : '#2ecc71'};">
                ${loansInMora.length}
            </p>
            <p style="margin:0; font-size:0.9em; color:#888;">Pr√©stamos con 1+ cuota de atraso.</p>
        </div>
    </div>

    <h3>Distribuci√≥n de Capital Prestado</h3>
    <div class="card">
        <div style="max-height: 400px;"> 
            <canvas id="loanDistributionChart"></canvas>
        </div>
    </div>
  `;
  
  renderLoanDistributionChart();
}

function renderLoanDistributionChart() {
    const loans = DB.get("loans");
    if (loans.length === 0) return;

    // Calcular la suma de los montos de pr√©stamos por cliente
    const clientAmounts = {};
    loans.forEach(loan => {
        clientAmounts[loan.clientName] = (clientAmounts[loan.clientName] || 0) + Number(loan.amount);
    });

    const labels = Object.keys(clientAmounts);
    const data = Object.values(clientAmounts);
    
    // Funci√≥n simple para generar colores de forma consistente
    const getColors = (count) => {
        const colors = [
            '#1c5d99', '#4a6d4a', '#f39c12', '#e74c3c', '#9b59b6', 
            '#34495e', '#1abc9c', '#f1c40f', '#2980b9', '#c0392b'
        ];
        return Array.from({length: count}, (_, i) => colors[i % colors.length]);
    };

    new Chart(document.getElementById('loanDistributionChart'), {
        type: 'pie',
        data: {
            labels: labels,
            datasets: [{
                label: 'Monto Prestado',
                data: data,
                backgroundColor: getColors(labels.length),
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false, // Permitir que el contenedor maneje la altura
            plugins: {
                legend: {
                    position: 'top',
                },
                title: {
                    display: true,
                    text: 'Monto Principal Prestado por Cliente'
                }
            }
        }
    });
}


// ===============================================
// FUNCI√ìN AUXILIAR: CALCULAR MONTO TOTAL PRESTADO POR CLIENTE
// ===============================================
function calculateTotalLoanAmount(clientId) {
    const loans = DB.get("loans");
    // Suma el monto (capital principal) de todos los pr√©stamos asociados a ese cliente
    return loans
        .filter(l => l.clientId === clientId)
        .reduce((sum, current) => sum + Number(current.amount), 0);
}


// ===============================================
// VISTA: CLIENTES
// ===============================================
function renderClients(){
  main.innerHTML = `
    <h2>Clientes üë•</h2>
    <div style="margin-bottom:20px;">
        <input id="client-search" placeholder="Buscar por Nombre o C√©dula..." class="form-input" onkeyup="refreshClientsList(this.value)">
    </div>
    
    <div class="card" style="background: #f0f7ff; border: 1px solid #d0e8ff;">
        <h3 style="margin-top:0;">Agregar Nuevo Cliente</h3>
        <div style="display:grid; gap:10px;">
            <input id="client-name" placeholder="Nombre (Requerido)" class="form-input">
            <input type="number" id="client-cedula" placeholder="C√©dula (Requerido)" class="form-input">
            <input id="client-address" placeholder="Direcci√≥n Residencial" class="form-input">
            <input type="tel" id="client-phone-main" placeholder="Tel√©fono Principal" class="form-input"> 
            <input type="tel" id="client-phone-mobile" placeholder="Celular" class="form-input">
            <button class="action-btn" onclick="addClient()">Agregar Cliente</button>
        </div>
    </div>
    
    <div id="no-clients-warning" style="display:none; text-align:center; padding:20px; border-radius:10px; background:#fff3cd; border:1px solid #ffeeba; color:#856404; margin-bottom:20px;">
        ‚ö†Ô∏è **No hay clientes registrados.** Por favor, a√±ada uno usando el formulario de arriba.
    </div>

    <div id="clients-list"></div>
  `;
  refreshClientsList();
}

function addClient(){
  const name = document.getElementById("client-name").value.trim();
  const cedula = document.getElementById("client-cedula").value.trim();
  const address = document.getElementById("client-address").value.trim();
  const phoneMain = document.getElementById("client-phone-main").value.trim();
  const phoneMobile = document.getElementById("client-phone-mobile").value.trim();
  
  if(!name || !cedula) {
    showToast("Nombre y C√©dula son requeridos", 'error'); // MEJORA 15
    return;
  }
  
  const all = DB.get("clients");
  all.push({
    id: genId(), 
    name, 
    cedula,             
    address,            
    phoneMain,          
    phoneMobile         
  });
  DB.set("clients", all);
  
  // Limpiar el formulario y refrescar la lista
  document.getElementById("client-name").value = '';
  document.getElementById("client-cedula").value = '';
  document.getElementById("client-address").value = '';
  document.getElementById("client-phone-main").value = '';
  document.getElementById("client-phone-mobile").value = '';
  
  refreshClientsList();
  showToast("Cliente agregado correctamente", 'success'); // MEJORA 15
}

function refreshClientsList(searchTerm = ''){
  let list = DB.get("clients");
  const box = document.getElementById("clients-list");
  const warningBox = document.getElementById("no-clients-warning");
  
  if(searchTerm.trim()){
    const term = searchTerm.toLowerCase().trim();
    list = list.filter(c => 
      c.name.toLowerCase().includes(term) || 
      c.cedula.toLowerCase().includes(term)
    );
  }

  if(list.length===0){ 
    box.innerHTML=`<p style="text-align:center; padding:20px;">${searchTerm ? 'No se encontraron clientes que coincidan con la b√∫squeda.' : ''}</p>`; 
    if (!searchTerm && warningBox) {
        warningBox.style.display = 'block'; // Mostrar la advertencia si no hay clientes y no hay b√∫squeda
    } else if (warningBox) {
        warningBox.style.display = 'none';
    }
    return; 
  } else if (warningBox) {
      warningBox.style.display = 'none';
  }
  
  box.innerHTML = list.map(c=>{
    // Se calcula el monto total prestado (capital principal)
    const totalPrestado = calculateTotalLoanAmount(c.id);

    return `
      <div class="card" id="client-card-${c.id}">
          <div id="client-view-${c.id}">
              <h4 style="margin:0 0 5px 0; color:#1c5d99;">${c.name}</h4>
              C√©dula: ${c.cedula || 'N/A'}<br>
              Dir: ${c.address || 'N/A'}<br>
              Total Capital Prestado: <b style="color:#2ecc71;">${formatCurrency(totalPrestado)}</b><br>
              Tel: ${c.phoneMain || 'N/A'} / Cel: ${c.phoneMobile || 'N/A'}<br><br>
              
              <div style="display:flex; gap:10px;">
                  <button class="action-btn" style="flex:1; background:#f39c12;" onclick="prepareEdit('${c.id}')">‚úèÔ∏è Editar</button>
                  <button class="action-btn" style="flex:1; background:#e74c3c;" onclick="deleteClient('${c.id}')">üóëÔ∏è Eliminar</button>
              </div>
          </div>
          <div id="client-edit-${c.id}" style="display:none;">
          </div>
      </div>
    `;
  }).join("");
}

// MEJORA 12: FUNCI√ìN: ELIMINACI√ìN EN CASCADA (CLIENTE)
function deleteClient(id) {
    if (!confirm("ADVERTENCIA: ¬øEst√° seguro de que desea eliminar a este cliente? Esto eliminar√° PERMANENTEMENTE todos sus pr√©stamos y el historial de cobros asociados.")) return;

    // 1. Eliminar el Cliente
    let allClients = DB.get("clients");
    allClients = allClients.filter(c => c.id !== id);
    DB.set("clients", allClients);
    
    // 2. Eliminar Pr√©stamos (Loans) del Cliente
    let allLoans = DB.get("loans");
    // Obtenemos la lista de pr√©stamos que se van a eliminar para obtener sus IDs.
    const loansToDelete = allLoans.filter(l => l.clientId === id); 
    // Mantenemos solo los pr√©stamos cuyo clientId NO coincida con el id del cliente a borrar
    allLoans = allLoans.filter(l => l.clientId !== id);
    DB.set("loans", allLoans);

    // 3. Eliminar Cobros (Historial de Transacciones) del Cliente
    let allCobros = DB.getInitialCobros();
    // Obtenemos los IDs de los pr√©stamos que se est√°n borrando
    const loanIdsToDelete = loansToDelete.map(l => l.id);
    
    // Mantenemos solo los cobros cuyo loanId NO est√© en la lista de loanIdsToDelete
    allCobros = allCobros.filter(c => !loanIdsToDelete.includes(c.loanId));
    DB.set("cobros", allCobros);

    // Refrescar la lista de clientes en la vista actual
    const searchTerm = document.getElementById("client-search") ? document.getElementById("client-search").value : '';
    refreshClientsList(searchTerm);
    
    // Mensaje de confirmaci√≥n (MEJORA 15)
    showToast("Cliente, pr√©stamos y cobros asociados eliminados correctamente.", 'warning');
}
// ===============================================


function prepareEdit(id) {
    const client = DB.get("clients").find(c => c.id === id);
    if (!client) return;

    // Calcular el monto total prestado para MOSTRARLO (no editar)
    const totalPrestado = calculateTotalLoanAmount(id);

    document.getElementById(`client-view-${id}`).style.display = 'none';
    const editBox = document.getElementById(`client-edit-${id}`);
    editBox.style.display = 'block';

    editBox.innerHTML = `
        <input id="edit-name-${id}" value="${client.name}" placeholder="Nombre" class="form-input" style="margin-bottom:5px;">
        <input type="number" id="edit-cedula-${id}" value="${client.cedula}" placeholder="C√©dula" class="form-input" style="margin-bottom:5px;">
        <input id="edit-address-${id}" value="${client.address || ''}" placeholder="Direcci√≥n Residencial" class="form-input" style="margin-bottom:5px;">
        <input type="tel" id="edit-phone-main-${id}" value="${client.phoneMain || ''}" placeholder="Tel√©fono Principal" class="form-input" style="margin-bottom:5px;">
        <input type="tel" id="edit-phone-mobile-${id}" value="${client.phoneMobile || ''}" placeholder="Celular" class="form-input" style="margin-bottom:10px;">
        
        <p style="margin: 0 0 10px 0; padding:10px; background:#f0f0f0; border-radius:5px;">
            **Capital Total Prestado:** <span style="font-weight:bold; color:#1c5d99;">${formatCurrency(totalPrestado)}</span> 
            (No editable aqu√≠. Se gestiona en "Pr√©stamos")
        </p>

        <div style="display:flex; gap:10px;">
            <button class="action-btn" style="flex:1; background:#2ecc71;" onclick="saveClient('${id}')">üíæ Guardar Cambios</button>
            <button class="action-btn" style="flex:1; background:#95a5a6;" onclick="cancelEdit('${id}')">‚ùå Cancelar</button>
        </div>
    `;
}

function cancelEdit(id) {
    document.getElementById(`client-view-${id}`).style.display = 'block';
    document.getElementById(`client-edit-${id}`).style.display = 'none';
    document.getElementById(`client-edit-${id}`).innerHTML = ''; // Limpiar el contenido de edici√≥n
}

function saveClient(id) {
    const name = document.getElementById(`edit-name-${id}`).value.trim();
    const cedula = document.getElementById(`edit-cedula-${id}`).value.trim();
    const address = document.getElementById(`edit-address-${id}`).value.trim();
    const phoneMain = document.getElementById(`edit-phone-main-${id}`).value.trim();
    const phoneMobile = document.getElementById(`edit-phone-mobile-${id}`).value.trim();

    if(!name || !cedula) {
        showToast("Nombre y C√©dula son requeridos para guardar.", 'error'); // MEJORA 15
        return;
    }

    let all = DB.get("clients");
    const index = all.findIndex(c => c.id === id);
    if (index === -1) return;

    all[index] = {
        id: id, 
        name, 
        cedula,             
        address,            
        phoneMain,          
        phoneMobile
    };

    DB.set("clients", all);
    
    const searchTerm = document.getElementById("client-search") ? document.getElementById("client-search").value : '';
    refreshClientsList(searchTerm);
    showToast("Cliente guardado correctamente.", 'success'); // MEJORA 15
}

// ===============================================
// VISTA: PR√âSTAMOS
// ===============================================

function renderLoans() {
    const settings = DB.getSettings();
  main.innerHTML = `
    <h2>Pr√©stamos üíµ</h2>
    
    <div class="card" style="text-align:left; background: #f0f7ff; border: 1px solid #d0e8ff;">
        <h3>Registrar Nuevo Pr√©stamo (Cuotas Fijas)</h3>
        
        <label for="loan-client" style="display:block; font-weight:bold; margin-bottom:5px;">Cliente:</label>
        <select id="loan-client" class="form-input" style="margin-bottom:15px;">
            <option value="">-- Seleccione un Cliente --</option>
        </select>
        
        <label for="loan-amount" style="display:block; font-weight:bold; margin-bottom:5px;">Monto del pr√©stamo (${settings.currencySymbol}):</label>
        <input type="number" id="loan-amount" placeholder="Monto Principal (${settings.currencySymbol})" class="form-input" value="10000" min="1" style="margin-bottom:15px;">
        
        <label for="loan-interest-base" style="display:block; font-weight:bold; margin-bottom:5px;">Porcentaje de inter√©s base (%) - Para 3 meses:</label>
        <input type="number" id="loan-interest-base" placeholder="Tasa Base (%)" class="form-input" value="${settings.baseInterestRate}" min="0" step="0.1" style="margin-bottom:15px;">
        
        <label for="loan-term" style="display:block; font-weight:bold; margin-bottom:5px;">Plazo (meses):</label>
        <input type="number" id="loan-term" placeholder="Plazo (Meses)" class="form-input" value="3" min="1" style="margin-bottom:15px;">
        
        <button class="action-btn" onclick="calculateAndSaveLoan()">‚ûï Calcular y Registrar Pr√©stamo</button>
        
        <div id="calculator-summary" style="margin-top: 15px; padding: 15px; border-radius: 8px; background: #fff; border: 1px dashed #ccc;"></div>
    </div>
    
    <div style="margin-top:20px;">
        <h3>Pr√©stamos Activos y Pagados</h3>
        <div id="loans-list">
            </div>
    </div>
  `;
  populateClientSelect(); // Llena el selector de clientes
  refreshLoanList();      // Carga la lista de pr√©stamos existentes
}

function populateClientSelect() {
    const clients = DB.get("clients");
    const select = document.getElementById("loan-client");

    if (clients.length === 0) {
        select.innerHTML = '<option value="" disabled>No hay clientes para prestar</option>';
        return;
    }

    // Asegurarse de que el primer elemento sea el placeholder
    select.innerHTML = '<option value="">-- Seleccione un Cliente --</option>'; 
    
    clients.forEach(c => {
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.name} (C√©dula: ${c.cedula})`;
        select.appendChild(option);
    });
}

// ====================================================================
// L√ìGICA DE C√ÅLCULO Y REGISTRO DE PR√âSTAMO
// ====================================================================
function calculateAndSaveLoan() {
    const clientId = document.getElementById("loan-client").value;
    const P = Number(document.getElementById("loan-amount").value); // Monto del pr√©stamo
    
    // Obtener la tasa de inter√©s base del formulario (ya precargada con settings.baseInterestRate)
    const interesBase = Number(document.getElementById("loan-interest-base").value); 
    const n = Number(document.getElementById("loan-term").value); // Plazo (meses)
    
    if (!clientId) {
        showToast("Por favor, seleccione un cliente.", 'error'); // MEJORA 15
        return;
    }
    if (P <= 0 || interesBase < 0 || n <= 0) {
        showToast("Por favor, complete todos los campos de la calculadora correctamente con valores positivos.", 'error'); // MEJORA 15
        return;
    }

    const client = DB.get("clients").find(c => c.id === clientId);
    if (!client) {
        showToast("Cliente no encontrado.", 'error'); // MEJORA 15
        return;
    }

    // L√≥gica de Cuotas Iguales con Inter√©s Proporcional
    // Tasa total de inter√©s (proporcional a la tasa base de 3 meses)
    const totalInteres = P * (interesBase / 100) * (n / 3);
    const totalPagar = P + totalInteres;
    const cuotaMensual = totalPagar / n;

    // Mostrar el resumen del c√°lculo
    let resultadoHTML = `
        <h4 style="margin-top:0;">Resumen del Pr√©stamo</h4>
        <p style="border-top: 1px solid #ccc; padding-top: 10px;">
            <strong>Monto Pr√©stamo:</strong> ${formatCurrency(P)}<br>
            <strong>Inter√©s Total:</strong> ${formatCurrency(totalInteres)}<br>
            <strong>Total a Pagar:</strong> ${formatCurrency(totalPagar)}<br>
            <strong style="color:#1c5d99; font-size: 1.2em;">Cuota Mensual Fija: ${formatCurrency(cuotaMensual)}</strong>
        </p>
    `;
    document.getElementById('calculator-summary').innerHTML = resultadoHTML;
    
    // Objeto para registrar el nuevo pr√©stamo
    const newLoan = {
        id: genId(),
        clientId: clientId,
        clientName: client.name,
        amount: P.toFixed(2), // Guardar como string con 2 decimales
        interestRateBase: interesBase,
        termMonths: n,
        monthlyPayment: cuotaMensual.toFixed(2),
        totalInterest: totalInteres.toFixed(2),
        date: new Date().toLocaleDateString(),
        status: 'Activo',
        paymentsMade: 0, 
        totalPaidAmount: 0, 
        startDate: new Date().toISOString().split('T')[0] // Formato YYYY-MM-DD
    };

    const allLoans = DB.get("loans");
    allLoans.push(newLoan);
    DB.set("loans", allLoans);

    showToast(`Pr√©stamo registrado. Cuota Mensual: ${formatCurrency(newLoan.monthlyPayment)}`, 'success'); // MEJORA 15
    
    // Limpiar formulario (manteniendo los valores por defecto)
    const settings = DB.getSettings();
    document.getElementById("loan-amount").value = '10000';
    document.getElementById("loan-interest-base").value = settings.baseInterestRate;
    document.getElementById("loan-term").value = '3';
    document.getElementById("loan-client").value = '';
    document.getElementById('calculator-summary').innerHTML = ''; // Limpiar el resumen

    refreshLoanList(); // Actualiza la lista de pr√©stamos
}


// MEJORA 12: FUNCI√ìN DE ELIMINACI√ìN DE PR√âSTAMO INDIVIDUAL (CASCADA)
function deleteLoan(id) {
    if (!confirm("ADVERTENCIA: ¬øEst√° seguro de que desea eliminar este PR√âSTAMO? Esto eliminar√° PERMANENTEMENTE este pr√©stamo y todos los cobros asociados a √©l.")) return;

    // 1. Eliminar el Pr√©stamo
    let allLoans = DB.get("loans");
    allLoans = allLoans.filter(l => l.id !== id);
    DB.set("loans", allLoans);
    
    // 2. Eliminar Cobros (Historial de Transacciones) asociados a este LoanId
    let allCobros = DB.getInitialCobros();
    allCobros = allCobros.filter(c => c.loanId !== id);
    DB.set("cobros", allCobros);

    refreshLoanList(); 
    
    // Si la vista de Cobros est√° abierta, refrescarla tambi√©n
    if (document.getElementById('pending-payments-list')) {
        refreshPendingPayments();
    }

    showToast("Pr√©stamo y sus cobros asociados eliminados correctamente.", 'warning'); // MEJORA 15
}
// ===============================================

// MEJORA 13: FUNCI√ìN DE C√ÅLCULO DE RIESGO DE MORA (MEJORADA Y M√ÅS ROBUSTA)
function calculateLoanRisk(loan) {
    const today = new Date();
    // Normalizar la fecha de inicio para evitar problemas de zona horaria al calcular los meses
    const startDate = new Date(loan.startDate + 'T00:00:00'); 
    const cuotaMensual = Number(loan.monthlyPayment);
    const paymentsMade = Number(loan.paymentsMade);
    const termMonths = Number(loan.termMonths);

    // Si est√° pagado, no hay mora
    if (loan.status === 'Pagado') {
        return { paymentsDue: termMonths, paymentsMade: termMonths, monthsBehind: 0, totalDue: 0, nextDueDate: null };
    }

    // --- C√ÅLCULO ROBUSTO DE CUOTAS VENCIDAS ---
    let paymentsDue = 0;
    let nextDueDate = null;

    // Iteramos por todas las posibles cuotas, desde la 1 hasta el total del plazo
    for (let i = 1; i <= termMonths; i++) {
        // La cuota i vence i meses despu√©s de la fecha de inicio
        let dueDate = new Date(startDate);
        dueDate.setMonth(startDate.getMonth() + i);

        // Ajuste para mantener el d√≠a de inicio
        if (startDate.getDate() !== dueDate.getDate()) {
            // Ajustar al √∫ltimo d√≠a del mes si es necesario
            dueDate.setDate(0); 
            dueDate.setDate(startDate.getDate()); 
            // Esto es solo un ajuste para mantener la l√≥gica de "d√≠a de pago" consistente
        }

        // Si la fecha de vencimiento es HOY o en el PASADO (consideramos HOY vencido)
        const dateOnlyToday = new Date(today.getFullYear(), today.getMonth(), today.getDate());
        const dateOnlyDue = new Date(dueDate.getFullYear(), dueDate.getMonth(), dueDate.getDate());
        
        if (dateOnlyToday >= dateOnlyDue) {
            paymentsDue = i; // La cuota 'i' ha vencido
        } else {
            // Si encontramos una cuota que vence en el futuro, esa es la pr√≥xima fecha.
            nextDueDate = dueDate.toISOString().split('T')[0];
            break; 
        }
    }
    
    // 1. Calcular Cuotas Atrasadas (Mora)
    let monthsBehind = Math.max(0, paymentsDue - paymentsMade);
    
    // 2. Calcular el monto total adeudado (cuotas atrasadas)
    // El monto adeudado es el monto de las cuotas vencidas y no pagadas
    let totalDue = cuotaMensual * monthsBehind;

    // Si paymentsDue alcanz√≥ el total del plazo pero paymentsMade es menor, el nextDueDate es nulo (vencimiento expirado)
    if (paymentsDue === termMonths && paymentsMade < termMonths) {
        nextDueDate = null;
    }

    return {
        paymentsDue, // Cuotas que deber√≠an haberse pagado hasta ahora (m√°x. termMonths)
        paymentsMade: paymentsMade,
        monthsBehind,
        totalDue: totalDue,
        nextDueDate: nextDueDate
    };
}
// ===============================================

function refreshLoanList() {
    const loans = DB.get("loans");
    const box = document.getElementById("loans-list");
    
    if (loans.length === 0) {
        box.innerHTML = '<p style="text-align:center;">No hay pr√©stamos activos registrados.</p>';
        return;
    }

    const tableRows = loans.map(l => {
        const totalPagar = Number(l.amount) + Number(l.totalInterest);
        const paidPercentage = (l.totalPaidAmount / totalPagar) * 100;
        const risk = calculateLoanRisk(l);
        const statusColor = risk.monthsBehind > 0 ? '#e74c3c' : (l.status === 'Pagado' ? '#2ecc71' : '#f39c12');
        const statusText = risk.monthsBehind > 0 ? `Mora (${risk.monthsBehind} meses)` : l.status;
        const progressStyle = paidPercentage > 100 ? 100 : paidPercentage;
        
        // Determinar qu√© mostrar en "Pr√≥ximo Vencimiento"
        let nextDueText = 'N/A';
        if (l.status === 'Pagado') {
            nextDueText = 'Pr√©stamo saldado.';
        } else if (risk.monthsBehind > 0) {
            nextDueText = `<span style="color:red; font-weight:bold;">¬°En Mora!</span>`;
        } else if (risk.nextDueDate) {
             nextDueText = risk.nextDueDate.split('-').reverse().join('/'); // Formato DD/MM/AAAA
        } else {
             // Este caso solo aplica si el pr√©stamo est√° completamente vencido pero no pagado.
             nextDueText = 'Vencimiento Expirado';
        }

        return `
            <div class="card" style="border-left: 5px solid ${statusColor};">
                <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                    <h4 style="margin:0; color:#1c5d99;">${l.clientName}</h4>
                    <span style="background:${statusColor}; color:white; padding: 5px 10px; border-radius:5px; font-size:0.9em; font-weight:bold;">${statusText}</span>
                </div>
                <hr style="border: 0; height: 1px; background: #eee; margin: 10px 0;">
                <p style="margin: 5px 0; font-size:1.1em;">
                    Monto Principal: <b>${formatCurrency(l.amount)}</b><br>
                    Cuota Mensual: <b>${formatCurrency(l.monthlyPayment)}</b><br>
                    Pr√≥ximo Vencimiento: <b>${nextDueText}</b>
                </p>
                <p style="margin: 5px 0;">
                    Pagado: ${formatCurrency(l.totalPaidAmount)} / Total: ${formatCurrency(totalPagar)} 
                    (${l.paymentsMade}/${l.termMonths} cuotas)
                </p>
                
                <div style="background:#eee; border-radius:5px; height:10px; margin: 10px 0;">
                    <div style="background:${statusColor}; width:${progressStyle}%; height:10px; border-radius:5px;"></div>
                </div>
                
                <div style="display:flex; gap:10px; margin-top:10px;">
                    <button class="action-btn" style="flex:1; background:#1c5d99;" onclick="renderCobros('${l.id}')">üí∞ Registrar Cobro</button>
                    <button class="action-btn" style="flex:1; background:#e74c3c;" onclick="deleteLoan('${l.id}')">üóëÔ∏è Eliminar</button>
                </div>
            </div>
        `;
    }).join("");
    box.innerHTML = `<div id="loans-list" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px;">${tableRows}</div>`;
}

// ===============================================
// VISTA: COBROS (PAGOS)
// ===============================================

function renderCobros(loanIdToSelect = null) {
    const settings = DB.getSettings();
    main.innerHTML = `
        <h2>Registro de Cobros üí∞</h2>
        
        <div class="card" style="text-align:left; background: #f0f7ff; border: 1px solid #d0e8ff;">
            <h3>Registrar Pago a Pr√©stamo</h3>
            
            <label for="payment-loan-id" style="display:block; font-weight:bold; margin-bottom:5px;">Seleccionar Pr√©stamo:</label>
            <select id="payment-loan-id" class="form-input" style="margin-bottom:15px;" onchange="updatePaymentDetails()">
                <option value="">-- Seleccione un Pr√©stamo --</option>
            </select>

            <div id="loan-summary-payment" style="margin-bottom:15px; background:#fff; padding:15px; border-radius:8px; border:1px solid #eee;">
                Seleccione un pr√©stamo para ver el resumen de pago.
            </div>

            <label for="payment-amount" style="display:block; font-weight:bold; margin-bottom:5px;">Monto del Pago (${settings.currencySymbol}):</label>
            <input type="number" id="payment-amount" placeholder="Monto a Cobrar (${settings.currencySymbol})" class="form-input" min="0.01" step="0.01" style="margin-bottom:15px;">
            

            <button class="action-btn" onclick="registerPayment()">‚úÖ Registrar Cobro</button>
        </div>

        <div class="card" style="margin-top: 20px; background: #ffe0f0; border: 1px solid #f0cccc;">
             <h3>Generar Factura Manual</h3>
             <p>Seleccione un cobro del historial para generar o ver la factura retroactivamente.</p>
             <label for="invoice-cobro-id" style="display:block; font-weight:bold; margin-bottom:5px;">Seleccionar Cobro:</label>
             <select id="invoice-cobro-id" class="form-input" style="margin-bottom:15px;">
                <option value="">-- Seleccione un Cobro del Historial --</option>
             </select>
             <div style="display:flex; gap:10px;">
                <button class="action-btn" style="flex:1; background:#8e44ad;" onclick="generateInvoiceFromSelect(true)">üëÅÔ∏è Ver Factura PDF</button>
                <button class="action-btn" style="flex:1; background:#2ecc71;" onclick="generateInvoiceFromSelect(false)">‚¨áÔ∏è Descargar PDF</button>
             </div>
        </div>


        <div style="margin-top:20px;">
            <h3>Pagos Pendientes y en Mora</h3>
            <div id="pending-payments-list"></div>
        </div>
    `;

    populateLoanSelect(loanIdToSelect);
    populateCobroSelectForInvoice(); 
    refreshPendingPayments();
}

function populateLoanSelect(loanIdToSelect) {
    const loans = DB.get("loans").filter(l => l.status !== 'Pagado');
    const select = document.getElementById("payment-loan-id");
    
    select.innerHTML = '<option value="">-- Seleccione un Pr√©stamo --</option>'; 
    
    loans.forEach(l => {
        const totalPagar = Number(l.amount) + Number(l.totalInterest);
        const remaining = totalPagar - Number(l.totalPaidAmount);

        const option = document.createElement('option');
        option.value = l.id;
        option.textContent = `${l.clientName} (Resta: ${formatCurrency(remaining)})`;
        select.appendChild(option);
    });
    
    if (loanIdToSelect && select.querySelector(`option[value="${loanIdToSelect}"]`)) {
        select.value = loanIdToSelect;
        updatePaymentDetails(); // Cargar detalles si hay un ID preseleccionado
    }
}

// MEJORA 14: NUEVA FUNCI√ìN PARA POBLAR SELECT DE COBROS EN FACTURA
function populateCobroSelectForInvoice() {
    const allCobros = DB.getInitialCobros().sort((a, b) => new Date(b.fullDateTime) - new Date(a.fullDateTime)); // El m√°s reciente primero
    const select = document.getElementById("invoice-cobro-id");
    
    if (!select) return; // Salir si el select no existe (ej: estamos en otra vista)

    select.innerHTML = '<option value="">-- Seleccione un Cobro del Historial --</option>'; 
    
    allCobros.slice(0, 100).forEach(c => { // Limitar a 100 para no sobrecargar
        const option = document.createElement('option');
        option.value = c.id;
        option.textContent = `${c.date} - ${c.clientName} (${formatCurrency(c.amount)})`;
        select.appendChild(option);
    });
}

function generateInvoiceFromSelect(viewOnly) {
    const cobroId = document.getElementById("invoice-cobro-id").value;
    if (!cobroId) {
        showToast("Por favor, seleccione un cobro del historial.", 'error'); // MEJORA 15
        return;
    }
    
    // Al llamar sin el segundo par√°metro (previousState), la funci√≥n createInvoiceDocument 
    // recalcular√° el estado anterior retroactivamente.
    if (viewOnly) {
        viewInvoicePDF(cobroId); 
    } else {
        generateInvoicePDF(cobroId); 
    }
}
// FIN NUEVA FUNCI√ìN SELECT COBROS

function updatePaymentDetails() {
    const loanId = document.getElementById("payment-loan-id").value;
    const summaryBox = document.getElementById("loan-summary-payment");
    const paymentAmountInput = document.getElementById("payment-amount");
    
    summaryBox.innerHTML = 'Seleccione un pr√©stamo para ver el resumen de pago.';
    paymentAmountInput.value = ''; // Limpiar monto de pago

    if (!loanId) return;

    const loan = DB.get("loans").find(l => l.id === loanId);
    if (!loan) return;

    const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
    const remainingBalance = totalPagar - Number(loan.totalPaidAmount);
    const cuotaMensual = Number(loan.monthlyPayment);
    const risk = calculateLoanRisk(loan);
    
    let moraText = '';
    
    // Si el restante es menor a cero (por posibles desajustes de coma flotante)
    if (remainingBalance <= 0.01) { 
        paymentAmountInput.value = '0.00';
        moraText = '<p style="color:#2ecc71; font-weight:bold; margin: 5px 0;">Pr√©stamo completamente saldado.</p>';
    } else if (risk.monthsBehind > 0) {
        moraText = `<p style="color:#e74c3c; font-weight:bold; margin: 5px 0;">¬°En Mora! Adeuda ${risk.monthsBehind} cuota(s) por un total de ${formatCurrency(risk.totalDue)}.</p>`;
        paymentAmountInput.value = risk.totalDue.toFixed(2); // Sugerir el monto en mora
    } else if (remainingBalance > 0 && remainingBalance < cuotaMensual) {
        paymentAmountInput.value = remainingBalance.toFixed(2); // Sugerir el restante (pago final)
    } else {
        paymentAmountInput.value = cuotaMensual.toFixed(2); // Sugerir la cuota normal
    }


    summaryBox.innerHTML = `
        <p style="margin: 5px 0;">Cliente: <b>${loan.clientName}</b></p>
        <p style="margin: 5px 0;">Cuota Fija: <b>${formatCurrency(cuotaMensual)}</b></p>
        <p style="margin: 5px 0;">Saldo Restante: <b>${formatCurrency(remainingBalance)}</b></p>
        ${moraText}
    `;
}

function registerPayment() {
    const loanId = document.getElementById("payment-loan-id").value;
    const amount = Number(document.getElementById("payment-amount").value);
    
    if (!loanId || amount <= 0) {
        showToast("Seleccione un pr√©stamo e ingrese un monto v√°lido.", 'error'); // MEJORA 15
        return;
    }

    let allLoans = DB.get("loans");
    const loanIndex = allLoans.findIndex(l => l.id === loanId);
    if (loanIndex === -1) {
        showToast("Pr√©stamo no encontrado.", 'error'); // MEJORA 15
        return;
    }

    const loan = allLoans[loanIndex];
    const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
    const remainingBalance = totalPagar - Number(loan.totalPaidAmount);
    const cuotaMensual = Number(loan.monthlyPayment);
    
    if (amount > remainingBalance + 0.01) { // A√±adir un peque√±o margen por errores de coma flotante
        if (!confirm(`El monto de ${formatCurrency(amount)} es mayor al saldo pendiente (${formatCurrency(remainingBalance)}). ¬øDesea registrar el pago igual? El saldo restante se ajustar√° a cero.`)) {
            return;
        }
    }
    
    // 1. Guardar el estado ANTES del nuevo cobro para el c√°lculo de la factura
    const oldTotalPaidAmount = Number(loan.totalPaidAmount);
    // Calcular paymentsMadeBefore basado en el total pagado antes del cobro actual
    const oldPaymentsMade = Math.floor(oldTotalPaidAmount / cuotaMensual);

    // 2. Registrar el cobro
    let allCobros = DB.getInitialCobros();
    const newCobro = {
        id: genId(),
        loanId: loanId,
        clientName: loan.clientName,
        amount: amount.toFixed(2), // Guardar como string con 2 decimales
        date: new Date().toLocaleDateString(),
        fullDateTime: new Date().toISOString()
    };
    allCobros.push(newCobro);
    DB.set("cobros", allCobros);

    // 3. Actualizar el pr√©stamo
    loan.totalPaidAmount = oldTotalPaidAmount + amount;
    loan.paymentsMade = Math.floor(loan.totalPaidAmount / cuotaMensual);

    // 4. Revisar el estado
    const newRemaining = totalPagar - loan.totalPaidAmount;
    if (newRemaining <= 0.01) { 
        loan.status = 'Pagado';
        loan.totalPaidAmount = totalPagar; 
        loan.paymentsMade = Number(loan.termMonths); 
    } else {
        loan.status = 'Activo'; 
    }
    
    allLoans[loanIndex] = loan;
    DB.set("loans", allLoans);

    showToast(`Cobro de ${formatCurrency(amount)} registrado para ${loan.clientName}.`, 'success'); // MEJORA 15
    
    // MEJORA 14: L√ìGICA: GENERAR FACTURA AL COBRAR (PREGUNTA)
    if (confirm("Cobro exitoso. ¬øDesea ver y descargar la factura del pago en PDF?")) {
        // Enviar el ID del cobro reci√©n creado y el estado anterior
        viewInvoicePDF(newCobro.id, {
            oldTotalPaidAmount,
            oldPaymentsMade
        }); 
    }
    // **********************************************

    // Refrescar vistas
    document.getElementById("payment-amount").value = '';
    document.getElementById("payment-loan-id").value = '';
    document.getElementById("loan-summary-payment").innerHTML = 'Seleccione un pr√©stamo para ver el resumen de pago.';
    populateLoanSelect();
    populateCobroSelectForInvoice(); // Refrescar el select de factura
    refreshPendingPayments();
}

// ===============================================
// MEJORA 14: FUNCIONES DE FACTURACI√ìN PDF (ACTUALIZADO CON autoTable Y DETALLES DE RECIBO)
// ===============================================
let currentCobroId = null; // Variable global para saber qu√© cobro descargar

function createInvoiceDocument(cobroId, previousState = {}) {
    // 1. Obtener Datos
    const cobro = DB.getInitialCobros().find(c => c.id === cobroId);
    if (!cobro) { 
        showToast("Error: Cobro no encontrado para la factura.", 'error'); // MEJORA 15
        return null; 
    }

    const loan = DB.get("loans").find(l => l.id === cobro.loanId);
    if (!loan) { 
        showToast("Error: Pr√©stamo asociado no encontrado para la factura.", 'error'); // MEJORA 15
        return null; 
    }
    
    // Intentar obtener datos completos del cliente
    const client = DB.get("clients").find(cl => cl.id === loan.clientId) || { 
        name: loan.clientName, 
        cedula: 'N/A', 
        phoneMain: 'N/A', 
        phoneMobile: 'N/A', 
        address: 'N/A' 
    };
    
    const settings = DB.getSettings();
    
    // 2. Calcular Saldos
    const amountPaid = Number(cobro.amount);
    const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
    const cuotaMensual = Number(loan.monthlyPayment);
    
    // Determinar si se usa el estado de la DB o se recalcula retroactivamente
    const isStateProvided = previousState.oldTotalPaidAmount !== undefined;

    let totalPaidBefore = 0;
    let paymentsMadeBefore = 0;
    
    if (!isStateProvided) {
        // Recalcular el total pagado antes de ESTE cobro de forma retroactiva
        const allCobrosForLoan = DB.getInitialCobros()
            .filter(c => c.loanId === loan.id)
            .sort((a, b) => new Date(a.fullDateTime) - new Date(b.fullDateTime));
        
        // Sumar todos los cobros anteriores al cobro actual
        for (const c of allCobrosForLoan) {
            if (c.id === cobro.id) break; // Detener en el cobro que estamos facturando
            totalPaidBefore += Number(c.amount);
        }
        paymentsMadeBefore = Math.floor(totalPaidBefore / cuotaMensual);

    } else {
        totalPaidBefore = previousState.oldTotalPaidAmount;
        paymentsMadeBefore = previousState.oldPaymentsMade;
    }
    
    // *** CORRECCI√ìN CR√çTICA: Definir el saldo restante ANTES del pago
    const remainingBalanceBefore = totalPagar - totalPaidBefore; 
    
    // Recalcular la mora ANTES de este cobro para el desglose (basado en el estado ANTES)
    const oldRisk = calculateLoanRisk({ 
        ...loan, 
        totalPaidAmount: totalPaidBefore, 
        paymentsMade: paymentsMadeBefore 
    });
    
    // Cuanto de lo pagado cubri√≥ la mora que hab√≠a
    const moraPagada = Math.min(amountPaid, oldRisk.totalDue);
    
    // Abono que queda despu√©s de pagar la mora
    let abonoPrincipalInteres = amountPaid - moraPagada; 
    
    // L√≥gica para determinar el abono extra (adelanto)
    let abonoProximaCuota = 0;
    let abonoNormal = 0; // Monto que fue a cubrir la parte "normal" de la deuda (la cuota actual)

    if (abonoPrincipalInteres > 0) {
        // El abono normal es la porci√≥n que va a cubrir la cuota mensual
        abonoNormal = Math.min(cuotaMensual, abonoPrincipalInteres);
        
        // El adelanto es el excedente despu√©s de cubrir la mora y la cuota normal
        abonoProximaCuota = Math.max(0, abonoPrincipalInteres - abonoNormal);
    }
    
    // Aseguramos que el pago a la pr√≥xima cuota no sea negativo (aunque el c√°lculo anterior lo evita)
    abonoProximaCuota = Math.max(0, abonoProximaCuota);
    
    // Datos Finales
    const remainingBalanceAfter = totalPagar - (totalPaidBefore + amountPaid);
    // Para la factura, usar el c√°lculo simple de pagos/cuotas
    const paymentsMadeAfter = Math.floor((totalPaidBefore + amountPaid) / cuotaMensual); 


    // 3. Crear Documento PDF
    const doc = new jsPDF();
    const pageWidth = doc.internal.pageSize.getWidth(); // Para centrar elementos
    let y = 15; // Posici√≥n inicial Y

    // --- ENCABEZADO Y DATOS DE EMPRESA (T√∫) ---
    doc.setFontSize(18);
    doc.setTextColor(28, 93, 153); // Azul Oscuro
    doc.text("RECIBO DE PAGO", pageWidth / 2, y, { align: "center" });
    y += 10;
    
    doc.setFontSize(10);
    doc.setTextColor(51, 51, 51);
    doc.text("Presta Bill S.A. (Sistema de Pr√©stamos)", pageWidth / 2, y, { align: "center" });
    y += 5;
    doc.text("Tel: N/A - Dir: N/A", pageWidth / 2, y, { align: "center" });
    y += 10;
    
    // --- L√çNEA SEPARADORA ---
    doc.setDrawColor(200, 200, 200);
    doc.line(10, y, pageWidth - 10, y);
    y += 5;

    // --- DETALLES DEL RECIBO EN FORMATO PROFESIONAL DE 2 COLUMNAS ---
    doc.setFontSize(12);
    doc.setTextColor(0, 0, 0);

    const marginLeft = 10;
    // const marginRight = pageWidth - 10; // No se usa directamente aqu√≠

    const columnWidth = (pageWidth - 20) / 2; // ancho exacto de cada columna
    const col1X = marginLeft;
    const col2X = marginLeft + columnWidth + 5; // separador profesional

    // Helper para escribir pares de campos (integrado en el scope de la funci√≥n)
    function writeRow(leftText, rightText) {
        doc.text(leftText, col1X, y);
        // Alineaci√≥n derecha para el segundo campo, usando el ancho de columna
        doc.text(rightText, col2X + columnWidth - 5, y, { align: "right" }); 
        y += 7; // Espaciado entre filas
    }

    writeRow(`Recibo No: ${cobro.id.toUpperCase().substring(0, 8)}`, 
             `Fecha: ${cobro.date}`);

    writeRow(`Cliente: ${client.name}`, 
             `C√©dula: ${client.cedula || 'N/A'}`);

    writeRow(`Pr√©stamo ID: ${loan.id.toUpperCase().substring(0, 8)}`, 
             `Cuota Mensual Fija: ${formatCurrency(cuotaMensual)}`);

    writeRow(`Monto Principal: ${formatCurrency(loan.amount)}`, 
             `Total a Pagar (Ppal + Int): ${formatCurrency(totalPagar)}`);

    y += 5; // Separaci√≥n para la tabla

    // --- L√çNEA SEPARADORA ---
    doc.setDrawColor(200, 200, 200);
    doc.line(10, y, pageWidth - 10, y);
    y += 5;

    // --- TABLA DE DESGLOSE DE PAGO (USANDO autoTable) ---
    let desgloseData = [
         // Si hab√≠a mora, mostrarla
        ...(moraPagada > 0 ? [["Mora Atrasada Cubierta:", formatCurrency(moraPagada)]] : []),
        ["Abono a Cuota Normal:", formatCurrency(abonoNormal)],
        ...(abonoProximaCuota > 0 ? [["Aporte Extra/Adelanto Cuota:", formatCurrency(abonoProximaCuota)]] : []),
        // L√≠nea divisoria en el desglose
        ["--------------------------------", "--------------------------------"],
        ["MONTO TOTAL DE ESTE COBRO:", formatCurrency(amountPaid)],
    ];
    
    doc.autoTable({
        startY: y,
        head: [['Desglose del Pago', 'Monto']],
        body: desgloseData,
        theme: 'striped',
        styles: { fontSize: 10, cellPadding: 3 },
        headStyles: { fillColor: [44, 62, 80], textColor: 255 },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 100 },
            // MEJORA: Alinear el encabezado a la derecha para que quede sobre las cifras
            1: { halign: 'right', fontStyle: 'bold' } 
        },
        didParseCell: function(data) {
            // Estilo especial para la fila del monto total
            if (data.row.index === desgloseData.length - 1) {
                data.cell.styles.fillColor = [220, 240, 220]; // Verde claro
            }
        },
        willDrawCell: function(data) {
            if (data.row.index === desgloseData.length - 1 && data.section === 'body') {
                doc.setFontSize(12);
                doc.setTextColor(46, 204, 113); // Color verde para el monto pagado
            } else if (data.section === 'body') {
                 doc.setFontSize(10);
                 doc.setTextColor(0, 0, 0);
            }
        }
    });
    
    y = doc.autoTable.previous.finalY + 5;

    // --- TABLA DE SALDOS FINALES (USANDO autoTable) ---
    const finalData = [
        ["Saldo Pendiente ANTES de este Pago:", formatCurrency(remainingBalanceBefore)],
        ["SALDO PENDIENTE DESPU√âS del Pago:", formatCurrency(remainingBalanceAfter)],
        ["Cuotas Pagadas (Acumulado):", `${paymentsMadeAfter} de ${loan.termMonths}`]
    ];
    
    doc.autoTable({
        startY: y,
        head: [['Estado del Pr√©stamo', 'Monto/Valor']],
        body: finalData,
        theme: 'plain',
        styles: { fontSize: 10, cellPadding: 3 },
        headStyles: { fillColor: [28, 93, 153], textColor: 255 },
        columnStyles: {
            0: { fontStyle: 'bold', cellWidth: 100 },
            // MEJORA: Alinear el encabezado a la derecha para que quede sobre las cifras
            1: { halign: 'right', fontStyle: 'bold' } 
        },
        didParseCell: function(data) {
            // Estilo especial para la fila del saldo final
            if (data.row.index === 1) {
                data.cell.styles.fillColor = [200, 220, 240];
            }
        },
    });

    y = doc.autoTable.previous.finalY + 10;
    
    // --- NOTAS FINALES ---
    doc.setFontSize(10);
    doc.setTextColor(100, 100, 100);
    doc.text('Este documento es un comprobante de pago. Guarde para sus registros.', 10, y);
    y += 5;
    doc.text(`*El estado final del pr√©stamo es: ${remainingBalanceAfter > 0.01 ? 'Activo' : 'Pagado'}.`, 10, y);

    // --- PIE DE P√ÅGINA (Firma) ---
    y = doc.internal.pageSize.height - 30; // 30mm desde el fondo
    doc.line(70, y, 140, y);
    doc.text('Firma/Sello de Presta Bill', pageWidth / 2, y + 5, { align: "center" });

    return { doc, clientName: client.name, cobroDate: cobro.date };
}

// FUNCI√ìN: GENERAR Y DESCARGAR FACTURA PDF
function generateInvoicePDF(cobroId, previousState = {}) {
    const result = createInvoiceDocument(cobroId, previousState);
    if (!result) return;
    
    const { doc, clientName, cobroDate } = result;

    // 4. Guardar PDF y emitir mensaje de descarga
    const fileName = `Factura_Cobro_${clientName.replace(/\s/g, '_')}_${cobroDate.replace(/\//g, '-')}.pdf`;
    doc.save(fileName);
    // *** CAMBIO CLAVE AQU√ç ***
    showToast(`Factura descargada: ${fileName}`, 'info'); 
}

// FUNCI√ìN: GENERAR Y VISUALIZAR FACTURA PDF (NUEVA)
function viewInvoicePDF(cobroId, previousState = {}) {
    const result = createInvoiceDocument(cobroId, previousState);
    if (!result) return;
    
    const { doc, clientName, cobroDate } = result;

    // 1. Convertir el PDF a Data URI
    const pdfDataUri = doc.output('datauristring');
    
    // 2. Cargar en el iframe
    const iframe = document.getElementById('invoice-iframe');
    const modal = document.getElementById('invoice-modal');
    const title = document.getElementById('modal-invoice-title');
    
    iframe.src = pdfDataUri;
    title.textContent = `Factura de Cobro: ${clientName} (${cobroDate})`;
    currentCobroId = cobroId; // Guardar el ID para la descarga
    
    // 3. Mostrar el modal
    modal.style.display = 'flex';
}

// Funci√≥n para cerrar el modal
function closeInvoiceModal() {
    const modal = document.getElementById('invoice-modal');
    const iframe = document.getElementById('invoice-iframe');
    modal.style.display = 'none';
    iframe.src = 'about:blank'; // Limpiar el iframe
    currentCobroId = null; // Limpiar el ID
}

// Funci√≥n que usa el ID global para la descarga
function downloadInvoice() {
    if (currentCobroId) {
        // Al descargar desde el modal, siempre regeneramos la factura por si la DB ha cambiado
        // Llamamos directamente a generateInvoicePDF para que descargue y muestre el Toast
        generateInvoicePDF(currentCobroId); 
        closeInvoiceModal(); // Cerramos el modal despu√©s de iniciar la descarga
    } else {
        showToast("No hay una factura seleccionada para descargar.", 'error'); // MEJORA 15
    }
}
// ===============================================


function refreshPendingPayments() {
    const allLoans = DB.get("loans").filter(l => l.status !== 'Pagado');
    const box = document.getElementById("pending-payments-list");

    if (allLoans.length === 0) {
        box.innerHTML = '<p style="text-align:center;">No hay pr√©stamos pendientes de pago.</p>';
        return;
    }

    const tableRows = allLoans.map((l, index) => {
        const risk = calculateLoanRisk(l);
        const totalPagar = Number(l.amount) + Number(l.totalInterest);
        const remainingBalance = totalPagar - Number(l.totalPaidAmount);
        
        const moraClass = risk.monthsBehind > 0 ? 'mora-alert-text' : '';
        const moraText = risk.monthsBehind > 0 ? `${risk.monthsBehind} Meses` : 'Al d√≠a';
        const nextDueText = risk.nextDueDate ? risk.nextDueDate.split('-').reverse().join('/') : 'N/A';
        // Si hay mora, mostrar el total de la mora. Si no, mostrar la cuota normal.
        const dueAmountText = risk.monthsBehind > 0 ? formatCurrency(risk.totalDue) : formatCurrency(l.monthlyPayment);

        // MEJORA 10: Doble clic para seleccionar y sugerir cobro
        return `
            <tr class="${index % 2 === 0 ? 'neutral-row-even' : 'neutral-row-odd'}"
                ondblclick="
                    document.getElementById('payment-loan-id').value='${l.id}'; 
                    updatePaymentDetails();
                    document.getElementById('payment-amount').scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                    document.getElementById('payment-amount').focus();" 
                style="cursor:pointer;">
                <td class="client-loan-cell">${l.clientName}</td>
                <td>${l.paymentsMade}/${l.termMonths}</td>
                <td>${nextDueText}</td>
                <td>${formatCurrency(remainingBalance)}</td>
                <td class="${moraClass}">${moraText}</td>
                <td>${dueAmountText}</td>
                <td>
                    <button class="action-btn" style="padding: 5px 10px; width:auto; font-size:14px; background:#4a6d4a;" 
                        onclick="event.stopPropagation(); 
                        document.getElementById('payment-loan-id').value='${l.id}'; 
                        updatePaymentDetails(); 
                        document.getElementById('payment-amount').scrollIntoView({ behavior: 'smooth', block: 'center' }); 
                        document.getElementById('payment-amount').focus();">Cobrar
                    </button>
                </td>
            </tr>
        `;
    }).join('');

    box.innerHTML = `
        <div class="card">
            <table>
                <thead>
                    <tr class="neutral-header">
                        <th>Cliente</th>
                        <th>Cuotas Pagas</th>
                        <th>Pr√≥x. Vencimiento</th>
                        <th>Saldo Total Restante</th>
                        <th>Estatus Mora</th>
                        <th>Monto Adeudado (Hoy)</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
            <p style="font-size:0.9em; margin-top:15px; color:#666;">*Doble clic en la fila para cargar el pr√©stamo en el formulario de pago.</p>
        </div>
    `;
}

// ===============================================
// VISTA: HISTORIAL DE COBROS
// ===============================================
function renderCobrosHistory() {
    main.innerHTML = `
        <h2>Historial de Transacciones (Cobros) üìú</h2>
        <div id="cobros-history-list"></div>
    `;
    refreshCobrosHistory();
}

function refreshCobrosHistory() {
    const allCobros = DB.getInitialCobros().sort((a, b) => new Date(b.fullDateTime) - new Date(a.fullDateTime)); // Ordenar por fecha, el m√°s reciente primero
    const box = document.getElementById("cobros-history-list");

    if (allCobros.length === 0) {
        box.innerHTML = '<p style="text-align:center; padding:20px;">No hay transacciones de cobros registradas.</p>';
        return;
    }

    const tableRows = allCobros.map((c, index) => `
        <tr class="${index % 2 === 0 ? 'neutral-row-even' : 'neutral-row-odd'}">
            <td>${c.date}</td>
            <td>${c.clientName}</td>
            <td>${formatCurrency(c.amount)}</td>
            <td>
                <button class="action-btn" style="padding: 5px 10px; width:auto; font-size:14px; background:#8e44ad; margin-right: 5px;" onclick="viewInvoicePDF('${c.id}')">üëÅÔ∏è Ver Factura</button>
                <button class="action-btn" style="padding: 5px 10px; width:auto; font-size:14px; background:#2ecc71; margin-right: 5px;" onclick="generateInvoicePDF('${c.id}')">‚¨áÔ∏è Descargar</button>
                <button class="action-btn" style="padding: 5px 10px; width:auto; font-size:14px; background:#e74c3c;" onclick="deleteCobro('${c.id}')">üóëÔ∏è Eliminar</button>
            </td>
        </tr>
    `).join('');

    box.innerHTML = `
        <div class="card">
            <table>
                <thead>
                    <tr class="neutral-header">
                        <th>Fecha</th>
                        <th>Cliente</th>
                        <th>Monto Cobrado</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </div>
    `;
}

// MEJORA 12: FUNCI√ìN DE ELIMINACI√ìN DE COBRO (CASCADA)
function deleteCobro(cobroId) {
    if (!confirm("ADVERTENCIA: ¬øEst√° seguro de que desea eliminar este cobro? Esto ajustar√° los saldos del pr√©stamo asociado.")) return;

    let allCobros = DB.getInitialCobros();
    const cobroIndex = allCobros.findIndex(c => c.id === cobroId);
    if (cobroIndex === -1) return;
    
    const cobroToDelete = allCobros[cobroIndex];
    allCobros.splice(cobroIndex, 1);
    DB.set("cobros", allCobros);
    
    // 1. Recalcular el estado del Pr√©stamo afectado
    let allLoans = DB.get("loans");
    const loanIndex = allLoans.findIndex(l => l.id === cobroToDelete.loanId);
    
    if (loanIndex !== -1) {
        const loan = allLoans[loanIndex];
        const totalPagar = Number(loan.amount) + Number(loan.totalInterest);
        const cuotaMensual = Number(loan.monthlyPayment);
        
        // Recalcular el total pagado sumando todos los cobros restantes de ese pr√©stamo
        const newTotalPaidAmount = allCobros
            .filter(c => c.loanId === loan.id)
            .reduce((sum, current) => sum + Number(current.amount), 0);

        loan.totalPaidAmount = newTotalPaidAmount;
        loan.paymentsMade = Math.floor(newTotalPaidAmount / cuotaMensual);

        // Revisar el nuevo estado
        const newRemaining = totalPagar - loan.totalPaidAmount;
        if (newRemaining > 0.01) { 
            loan.status = 'Activo';
        } else {
             loan.status = 'Pagado'; 
             loan.totalPaidAmount = totalPagar;
             loan.paymentsMade = Number(loan.termMonths);
        }
        
        allLoans[loanIndex] = loan;
        DB.set("loans", allLoans);
    }

    refreshCobrosHistory(); 
    
    // Si la vista de Cobros est√° abierta, refrescarla tambi√©n
    if (document.getElementById('pending-payments-list')) {
        refreshPendingPayments();
    }
    
    showToast("Cobro eliminado y saldo de pr√©stamo ajustado correctamente.", 'warning'); // MEJORA 15
}
// ===============================================


// ===============================================
// VISTA: REPORTES (SIN BLOQUEO PREMIUM)
// ===============================================
function renderReports() {
    
    const summary = calculateLoanPortfolioSummary();
    
    main.innerHTML = `
        <h2>Reportes y An√°lisis üìä</h2>
        
        <div class="dashboard-cards-container">
            <div class="card card-no-border-left" style="flex:1 1 200px; border-left: 5px solid #1c5d99;">
                <h3>Total Prestado (Principal)</h3>
                <p style="font-size:30px; font-weight:bold;">${formatCurrency(summary.totalPrincipalLent)}</p>
                <p style="margin:0; font-size:0.9em; color:#888;">Capital inicial prestado.</p>
            </div>
            <div class="card card-no-border-left" style="flex:1 1 200px; border-left: 5px solid #e74c3c;">
                <h3>Capital en Mora Adeudado</h3>
                <p style="font-size:30px; font-weight:bold; color:#e74c3c;">${formatCurrency(summary.moraAmount)}</p>
                <p style="margin:0; font-size:0.9em; color:#888;">Monto de cuotas vencidas y no pagadas.</p>
            </div>
        </div>

        <h3>Ranking de Clientes (Por Monto Prestado)</h3>
        <div id="client-ranking-list"></div>

        <h3>Detalle de Pr√©stamos en Mora</h3>
        <div id="mora-loans-detail-container">
            <div id="mora-loans-detail">Cargando...</div>
        </div>
    `;
    
    renderClientRanking();
    renderMoraLoansDetail();
}

function renderClientRanking() {
    const loans = DB.get("loans");
    const clientRanking = {};

    // 1. Agrupar por cliente y sumar montos originales prestados
    loans.forEach(loan => {
        if (!clientRanking[loan.clientId]) {
            clientRanking[loan.clientId] = {
                name: loan.clientName,
                totalAmount: 0,
                activeLoans: 0
            };
        }
        clientRanking[loan.clientId].totalAmount += Number(loan.amount);
        if (loan.status === 'Activo') {
            clientRanking[loan.clientId].activeLoans += 1;
        }
    });

    // 2. Convertir a array y ordenar por monto total
    let rankingArray = Object.values(clientRanking).sort((a, b) => b.totalAmount - a.totalAmount);

    if (rankingArray.length === 0) {
        document.getElementById('client-ranking-list').innerHTML = '<p style="text-align:center;">No hay datos de pr√©stamos para el ranking.</p>';
        return;
    }

    const tableRows = rankingArray.map((r, index) => `
        <tr class="${index % 2 === 0 ? 'neutral-row-even' : 'neutral-row-odd'}">
            <td>#${index + 1}</td>
            <td class="client-loan-cell">${r.name}</td>
            <td>${formatCurrency(r.totalAmount)}</td>
            <td>${r.activeLoans}</td>
        </tr>
    `).join('');

    document.getElementById('client-ranking-list').innerHTML = `
        <div class="card">
            <table>
                <thead>
                    <tr class="neutral-header">
                        <th>Ranking</th>
                        <th>Cliente</th>
                        <th>Total Prestado (Principal)</th>
                        <th>Pr√©stamos Activos</th>
                    </tr>
                </thead>
                <tbody>
                    ${tableRows}
                </tbody>
            </table>
        </div>
    `;
}

function renderMoraLoansDetail() {
    const allLoans = DB.get("loans");
    const loansInMora = allLoans
        .map(l => ({ ...l, risk: calculateLoanRisk(l) }))
        .filter(l => l.risk.monthsBehind > 0)
        .sort((a, b) => b.risk.monthsBehind - a.risk.monthsBehind); // El que m√°s debe primero

    const box = document.getElementById("mora-loans-detail");

    if (loansInMora.length === 0) {
        box.innerHTML = '<p style="text-align:center; padding:20px;">¬°Excelente! No hay pr√©stamos actualmente en mora.</p>';
        return;
    }
    
    const tableRows = loansInMora.map((l, index) => {
        const totalPagar = Number(l.amount) + Number(l.totalInterest);
        const remainingBalance = totalPagar - Number(l.totalPaidAmount);
        
        return `
            <tr class="${index % 2 === 0 ? 'neutral-row-even' : 'neutral-row-odd'}">
                <td class="client-loan-cell">${l.clientName}</td>
                <td class="mora-alert-text">${l.risk.monthsBehind}</td>
                <td>${l.paymentsMade}/${l.termMonths}</td>
                <td>${formatCurrency(remainingBalance)}</td>
                <td>${formatCurrency(l.risk.totalDue)}</td>
            </tr>
        `;
    }).join('');

    box.innerHTML = `
        <table>
            <thead>
                <tr class="neutral-header">
                    <th>Cliente</th>
                    <th>Meses Atraso</th>
                    <th>Cuotas Pagadas</th>
                    <th>Saldo Total Restante</th>
                    <th>Monto en Mora Adeudado (Cuotas)</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
    `;
}

// ===============================================
// VISTA: CONFIGURACIONES
// ===============================================
function renderSettings() {
    const settings = DB.getSettings();
    main.innerHTML = `
        <h2>Configuraciones Globales ‚öôÔ∏è</h2>
        <div class="card" style="background: #f0f7ff; border: 1px solid #d0e8ff;">
            <h3 style="margin-top:0;">Par√°metros Financieros</h3>
            <label for="setting-currency-symbol" style="display:block; font-weight:bold; margin-bottom:5px;">S√≠mbolo de Moneda (Ej: RD$, US$):</label>
            <input type="text" id="setting-currency-symbol" class="form-input" value="${settings.currencySymbol}" style="margin-bottom:15px;">
            
            <label for="setting-interest-rate" style="display:block; font-weight:bold; margin-bottom:5px;">Tasa de Inter√©s Base (%) - Para 3 meses:</label>
            <input type="number" id="setting-interest-rate" class="form-input" value="${settings.baseInterestRate}" min="0" step="0.1" style="margin-bottom:15px;">
            
            <button class="action-btn" onclick="saveSettings()">üíæ Guardar Configuraciones</button>
        </div>
    `;
}

function saveSettings() {
    const currencySymbol = document.getElementById("setting-currency-symbol").value.trim();
    const baseInterestRate = Number(document.getElementById("setting-interest-rate").value);
    
    if (!currencySymbol || baseInterestRate < 0) {
        showToast("Por favor, ingrese un s√≠mbolo de moneda y una tasa de inter√©s base v√°lida (mayor o igual a cero).", 'error'); // MEJORA 15
        return;
    }

    const newSettings = {
        currencySymbol: currencySymbol,
        baseInterestRate: baseInterestRate
    };
    
    DB.set("settings", newSettings);
    showToast("Configuraciones guardadas. Es posible que deba recargar las vistas para ver los cambios de moneda.", 'success'); // MEJORA 15
    
    // Recargar la vista actual para reflejar los cambios de inmediato
    renderSettings(); 
}

// ===============================================
// VISTA: MANTENIMIENTO
// ===============================================
function renderMaintenance() {
    main.innerHTML = `
        <h2>Mantenimiento y Respaldo üíæ</h2>
        
        <div class="card" style="background: #fff0f0; border: 1px solid #e74c3c;">
            <h3 style="color:#e74c3c;">Restablecer Datos</h3>
            <p>Esta acci√≥n eliminar√° todos los datos de Clientes, Pr√©stamos y Cobros de forma permanente. **¬°No se puede deshacer!**</p>
            <button class="action-btn" style="background:#c0392b;" onclick="resetData()">üóëÔ∏è Eliminar Todos los Datos</button>
        </div>
        
        <div class="card">
            <h3>Exportar Respaldo</h3>
            <p>Guarde un respaldo de todos los datos como un archivo JSON. Puede importarlo m√°s tarde o usarlo como copia de seguridad.</p>
            <button class="action-btn" onclick="exportData()">‚¨áÔ∏è Exportar Datos (JSON)</button>
        </div>
        
        <div class="card">
            <h3>Importar Respaldo</h3>
            <p>Seleccione un archivo JSON de respaldo para restaurar los datos. **Esto sobrescribir√° los datos existentes.**</p>
            <input type="file" id="import-file" accept=".json" class="form-input" style="margin-bottom:10px;">
            <button class="action-btn" onclick="importData()">‚¨ÜÔ∏è Importar Datos (JSON)</button>
        </div>
    `;
}

function resetData() {
    if (confirm("¬øEst√° absolutamente seguro? Se eliminar√°n todos los datos (Clientes, Pr√©stamos, Cobros, Configuraciones) de forma permanente.")) {
        localStorage.removeItem("clients");
        localStorage.removeItem("loans");
        localStorage.removeItem("cobros");
        localStorage.removeItem("settings");
        showToast("Todos los datos han sido eliminados. Se reiniciar√° la aplicaci√≥n al Dashboard.", 'warning'); // MEJORA 15
        renderDashboard(); 
    }
}

function exportData() {
    const data = {
        clients: DB.get("clients"),
        loans: DB.get("loans"),
        cobros: DB.getInitialCobros(),
        settings: DB.getSettings()
    };
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `PrestaBill_Respaldo_${new Date().toISOString().split('T')[0]}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    showToast("Datos exportados correctamente.", 'success'); // MEJORA 15
}

function importData() {
    const fileInput = document.getElementById("import-file");
    const file = fileInput.files[0];
    
    if (!file) {
        showToast("Por favor, seleccione un archivo JSON para importar.", 'error'); // MEJORA 15
        return;
    }
    
    if (!confirm("ADVERTENCIA: ¬øEst√° seguro? La importaci√≥n sobrescribir√° TODOS los datos actuales con el contenido del archivo.")) {
        return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const importedData = JSON.parse(e.target.result);
            
            if (importedData.clients && importedData.loans && importedData.cobros) {
                DB.set("clients", importedData.clients);
                DB.set("loans", importedData.loans);
                DB.set("cobros", importedData.cobros);
                
                // Opcional: importar configuraciones
                if (importedData.settings) {
                    DB.set("settings", importedData.settings);
                } else {
                     // Si el archivo viejo no tiene settings, asegurar que los default sigan
                     DB.set("settings", DEFAULT_SETTINGS); 
                }
                
                showToast("Datos importados y restaurados correctamente. Se reiniciar√° la aplicaci√≥n al Dashboard.", 'success'); // MEJORA 15
                renderDashboard();
            } else {
                showToast("Error: El archivo JSON no tiene la estructura de respaldo esperada (clients, loans, cobros).", 'error'); // MEJORA 15
            }
        } catch (error) {
            showToast("Error al procesar el archivo: " + error.message, 'error'); // MEJORA 15
        }
    };
    reader.readAsText(file);
}

// ===============================================
// INICIALIZACI√ìN
// ===============================================
document.addEventListener("DOMContentLoaded", renderDashboard);

</script>
</body>
</html>
